<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#698167">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="BushBuddy">
<link rel="apple-touch-icon" href="icon-192.png">

<script>
// PWA Installation handling
let deferredPrompt;
let installButton;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  showInstallButton();
});

function showInstallButton() {
  if (!installButton) {
    installButton = document.createElement('button');
    installButton.textContent = 'Install App';
    installButton.style.cssText = `
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: linear-gradient(135deg, #698167, #a0b2af);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    `;
    installButton.onclick = installApp;
    document.body.appendChild(installButton);
  }
}

function installApp() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((choiceResult) => {
      deferredPrompt = null;
      hideInstallButton();
    });
  }
}

function hideInstallButton() {
  if (installButton) {
    installButton.remove();
    installButton = null;
  }
}

window.addEventListener('appinstalled', (evt) => {
  hideInstallButton();
});

if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('./sw.js').then(function(registration) {
      console.log('ServiceWorker registration successful');
    }).catch(function(err) {
      console.log('ServiceWorker registration failed: ', err);
    });
  });
}
</script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BushBuddy</title>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #f5f7fa 0%, #e7f5e4 100%); min-height: 100vh; }
.container { max-width: 1200px; margin: 0 auto; }
.header { text-align: center; margin-bottom: 30px; color: #657a6b; }

.main-nav { 
  display: flex; 
  justify-content: flex-start;
  margin-bottom: 30px; 
  background: white; 
  border-radius: 15px; 
  padding: 10px; 
  box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
  overflow-x: auto; 
  overflow-y: hidden;
  scroll-behavior: smooth;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: thin;
  scrollbar-color: #698167 #f1f1f1;
}

.main-nav::-webkit-scrollbar { height: 6px; }
.main-nav::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
.main-nav::-webkit-scrollbar-thumb { background: #698167; border-radius: 3px; }
.main-nav::-webkit-scrollbar-thumb:hover { background: #5a6e5b; }

.nav-tab { 
  display: flex; 
  flex-direction: column; 
  align-items: center; 
  padding: 12px 16px; 
  margin: 0 4px; 
  border: none; 
  background: transparent; 
  color: #666; 
  cursor: pointer; 
  border-radius: 10px; 
  transition: all 0.3s ease; 
  font-weight: 600; 
  min-width: 80px; 
  font-size: 12px; 
  flex-shrink: 0;
  white-space: nowrap;
}
.nav-tab-icon { font-size: 20px; margin-bottom: 4px; }
.nav-tab-text { font-size: 11px; text-align: center; line-height: 1.2; }
.nav-tab:hover { background: rgba(43,122,120,0.1); color: #657a6b; }
.nav-tab.active { background: linear-gradient(135deg, #698167, #a0b2af); color: white; box-shadow: 0 4px 15px rgba(43,122,120,0.3); }

@media (min-width: 769px) and (max-width: 1024px) {
  .main-nav { justify-content: center; overflow-x: auto; }
  .nav-tab { padding: 16px 18px; min-width: 90px; }
  .nav-tab-icon { font-size: 22px; margin-bottom: 5px; }
  .nav-tab-text { font-size: 11px; }
}

@media (min-width: 1025px) {
  .main-nav { justify-content: center; overflow-x: visible; }
  .nav-tab { padding: 16px 20px; min-width: 100px; }
  .nav-tab-icon { font-size: 24px; margin-bottom: 6px; }
  .nav-tab-text { font-size: 12px; }
  .main-nav::-webkit-scrollbar { display: none; }
  .main-nav { scrollbar-width: none; }
}

@media (max-width: 768px) {
  .main-nav { justify-content: flex-start; overflow-x: auto; padding-bottom: 15px; }
  .main-nav::-webkit-scrollbar { height: 8px; display: block; }
  .main-nav::-webkit-scrollbar-thumb { background: #698167; border-radius: 4px; }
}

.card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); margin-bottom: 25px; }
.card h2 { margin-top: 0; color: #698167; font-size: 1.8em; }

label { display: block; margin-top: 15px; font-weight: 600; color: #555; }
input, select, textarea { width: 100%; padding: 12px; margin-top: 6px; border-radius: 10px; border: 2px solid #e1e8ed; box-sizing: border-box; font-size: 16px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-appearance: none; -webkit-border-radius: 10px; }
input:focus, select:focus, textarea:focus { outline: none; border-color: #698167; box-shadow: 0 0 0 3px rgba(43,122,120,0.1); }
textarea { resize: vertical; min-height: 80px; }

input[type="number"] { -webkit-appearance: none; -moz-appearance: textfield; }
input[type="date"] { -webkit-appearance: none; }
input[type="file"] { -webkit-appearance: none; }

@media screen and (max-width: 768px) {
  input, select, textarea { font-size: 16px; }
}

button { margin: 8px 4px; padding: 12px 20px; border: none; border-radius: 10px; background: linear-gradient(135deg, #698167, #a0b2af); color: white; cursor: pointer; font-weight: 600; transition: all 0.3s ease; min-height: 44px; font-size: 14px; }
button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(43,122,120,0.3); }
button.small { padding: 8px 12px; font-size: 12px; margin: 2px; min-height: 36px; }
button.danger { background: linear-gradient(135deg, #dc3545, #e74c3c); }

.tab-content { display: none; }
.tab-content.active { display: block; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

.animal-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
.animal-item { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 6px 25px rgba(0,0,0,0.1); position: relative; cursor: pointer; transition: all 0.3s ease; }
.animal-item:hover { transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0,0,0,0.15); }
.animal-item h4 { margin-top: 0; color: #698167; }
.animal-actions { position: absolute; top: 15px; right: 15px; display: flex; gap: 5px; }

.result { margin-top: 15px; padding: 15px; border-radius: 12px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-left: 4px solid #698167; }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <img src="BushBuddy.png" alt="BushBuddy Logo" style="max-height: 120px; max-width: 100%; height: auto; margin-bottom: 0;">
  </div>

  <div class="main-nav" id="mainNav">
    <button class="nav-tab active" onclick="showTab('home')">
      <div class="nav-tab-icon">üè†</div>
      <div class="nav-tab-text">Home</div>
    </button>
    <button class="nav-tab" onclick="showTab('add')">
      <div class="nav-tab-icon">‚ûï</div>
      <div class="nav-tab-text">Add New<br>Animal</div>
    </button>
    <button class="nav-tab" onclick="showTab('export')">
      <div class="nav-tab-icon">üìã</div>
      <div class="nav-tab-text">Backup &<br>Export</div>
    </button>
  </div>

  <!-- Home Tab -->
  <div id="homeTab" class="tab-content active">
    <div class="card">
      <h2>Your Animals</h2>
      
      <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
        <input type="text" id="animalSearch" placeholder="Search by name, species, or notes..." 
               style="flex: 1; min-width: 200px;">
        
        <select id="speciesFilter" 
                style="min-width: 200px; padding: 10px; border-radius: 10px; border: 2px solid #e1e8ed;">
          <option value="">All Species</option>
          <option value="Common Brushtail Possum">Common Brushtail Possum</option>
          <option value="Ringtail Possum">Ringtail Possum</option>
          <option value="Short-Eared Brushtail Possum">Short-Eared Brushtail Possum</option>
        </select>
      </div>
      
      <p id="animalCounter" style="color: #666; font-size: 14px; margin-bottom: 10px;"></p>

      <div id="animalList" class="animal-grid">
        <p style="text-align: center; color: #666; font-style: italic;">No animals added yet. Add your first animal using the "Add New Animal" tab!</p>
      </div>
    </div>
  </div>

  <!-- Add New Animal Tab -->
  <div id="addTab" class="tab-content">
    <div class="card">
      <h2>Add New Animal</h2>
      <label>Name: <input type="text" id="animalName" placeholder="Enter animal name"></label>
      <label>Species: 
        <select id="animalSpecies">
          <option value="Common Brushtail Possum">Common Brushtail Possum</option>
          <option value="Ringtail Possum">Ringtail Possum</option>
          <option value="Short-Eared Brushtail Possum">Short-Eared Brushtail Possum</option>
        </select>
      </label>
      <label>Intake Date: <input type="date" id="intakeDate"></label>
      <label>Intake Notes: <textarea id="intakeNotes" placeholder="Circumstances of rescue, initial condition, etc."></textarea></label>
      <button onclick="addAnimal()">Add Animal</button>
    </div>
  </div>

  <!-- Animal Detail View -->
  <div id="animalDetailTab" class="tab-content">
    <div style="margin-bottom: 20px;">
      <button onclick="showTab('home')" style="background: #6c757d; padding: 8px 16px;">‚Üê Back to Animals</button>
    </div>
    
    <div id="animalDetailContent">
    </div>
  </div>

  <!-- Export Tab -->
  <div id="exportTab" class="tab-content">
    <div class="card">
      <h2>Backup & Export</h2>
      <label>Select Animal for Export: <select id="exportAnimalSelect"><option value="">Select an animal...</option></select></label>
      <button onclick="exportAnimalData()">Export Care Data</button>
      
      <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 15px;">
        <h4>Backup & Restore</h4>
        <button onclick="exportAllData()">Backup All Data</button>
        <label>Restore Data: <input type="file" id="restoreInput" accept=".json"></label>
        <button onclick="restoreData()">Restore from Backup</button>
      </div>
    </div>
  </div>
</div>

<footer style="margin-top: 50px; padding: 30px 20px; background: rgba(255,255,255,0.9); border-top: 1px solid #e0e0e0; text-align: center; font-size: 12px; color: #666;">
  <div style="max-width: 1200px; margin: 0 auto;">
    <p><strong>Disclaimer:</strong> BushBuddy is a record-keeping tool designed to assist qualified wildlife carers. This application does not provide veterinary or professional wildlife care advice. Always consult with licensed wildlife veterinarians and follow established wildlife care protocols.</p>
    <p style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0;">¬© 2025 BushBuddy. All rights reserved.</p>
  </div>
</footer>

<script>
var animals = [];

// Initialize app
function initApp() {
  loadData();
  setDefaultDates();
  updateSelects();
  renderAnimals();
  
  var searchInput = document.getElementById('animalSearch');
  var speciesFilter = document.getElementById('speciesFilter');
  
  if (searchInput) {
    searchInput.addEventListener('input', renderAnimals);
  }
  
  if (speciesFilter) {
    speciesFilter.addEventListener('change', renderAnimals);
  }
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  var date = new Date(dateStr);
  var day = String(date.getDate()).padStart(2, '0');
  var month = String(date.getMonth() + 1).padStart(2, '0');
  var year = date.getFullYear();
  return day + '-' + month + '-' + year;
}

function saveData() {
  try {
    localStorage.setItem('bushbuddy_animals', JSON.stringify(animals));
  } catch (e) {
    console.error('Error saving data:', e);
    alert('Error saving data. Please try again.');
  }
}

function loadData() {
  try {
    var saved = localStorage.getItem('bushbuddy_animals');
    if (saved) {
      animals = JSON.parse(saved);
    } else {
      animals = [];
    }
  } catch (e) {
    console.error('Error loading data:', e);
    animals = [];
  }
}

function setDefaultDates() {
  var today = new Date().toISOString().split('T')[0];
  var intakeDate = document.getElementById('intakeDate');
  if (intakeDate) {
    intakeDate.value = today;
  }
}

function showTab(tabName) {
  document.querySelectorAll('.nav-tab').forEach(function(tab) { 
    tab.classList.remove('active'); 
  });
  document.querySelectorAll('.tab-content').forEach(function(content) { 
    content.classList.remove('active'); 
  });
  
  event.target.closest('.nav-tab').classList.add('active');
  document.getElementById(tabName + 'Tab').classList.add('active');
  
  updateSelects();
}

function updateSelects() {
  var exportSelect = document.getElementById('exportAnimalSelect');
  
  if (exportSelect) {
    var currentValue = exportSelect.value;
    exportSelect.innerHTML = '<option value="">Select an animal...</option>';
    
    animals.forEach(function(animal) {
      var option = document.createElement('option');
      option.value = animal.id;
      option.textContent = animal.name + ' (' + animal.species + ')';
      exportSelect.appendChild(option);
    });
    
    if (currentValue && animals.some(function(a) { return a.id == currentValue; })) {
      exportSelect.value = currentValue;
    }
  }
}

function addAnimal() {
  var name = document.getElementById('animalName').value.trim();
  var species = document.getElementById('animalSpecies').value;
  var intakeDate = document.getElementById('intakeDate').value;
  var intakeNotes = document.getElementById('intakeNotes').value.trim();
  
  if (!name || !species) {
    alert('Please enter animal name and species.');
    return;
  }
  
  var newAnimal = {
    id: Date.now(),
    name: name,
    species: species,
    intakeDate: intakeDate || new Date().toISOString().split('T')[0],
    intakeNotes: intakeNotes,
    weights: [],
    healthEntries: [],
    photos: [],
    treatments: [],
    feedingLogs: [],
    feedingTimes: []
  };
  
  animals.push(newAnimal);
  saveData();
  
  document.getElementById('animalName').value = '';
  document.getElementById('intakeDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('intakeNotes').value = '';
  
  renderAnimals();
  updateSelects();
  alert(name + ' has been added successfully!');
  
  showTab('home');
}

function renderAnimals() {
  var list = document.getElementById('animalList');
  var counter = document.getElementById('animalCounter');

  var searchQuery = document.getElementById('animalSearch') ? document.getElementById('animalSearch').value.trim().toLowerCase() : '';
  var speciesFilter = document.getElementById('speciesFilter') ? document.getElementById('speciesFilter').value : '';

  list.innerHTML = '';
  counter.textContent = '';

  if (animals.length === 0) {
    list.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No animals added yet. Add your first animal using the "Add New Animal" tab!</p>';
    return;
  }

  var filteredAnimals = animals.filter(function(animal) {
    var matchesSearch = !searchQuery ||
      (animal.name && animal.name.toLowerCase().includes(searchQuery)) ||
      (animal.species && animal.species.toLowerCase().includes(searchQuery)) ||
      (animal.intakeNotes && animal.intakeNotes.toLowerCase().includes(searchQuery));
    
    var matchesSpecies = !speciesFilter || animal.species === speciesFilter;
    
    return matchesSearch && matchesSpecies;
  });

  counter.textContent = 'Showing ' + filteredAnimals.length + ' of ' + animals.length + ' animals';

  if (filteredAnimals.length === 0) {
    list.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No matches found. Try adjusting your search or filter.</p>';
    return;
  }

  filteredAnimals.forEach(function(animal) {
    var div = document.createElement('div');
    div.className = 'animal-item';
    div.onclick = function() { showAnimalDetail(animal.id); };
    
    var daysSinceIntake = animal.intakeDate ? 
      Math.floor((new Date() - new Date(animal.intakeDate)) / (1000 * 60 * 60 * 24)) : 
      'Unknown';
    
    var latestWeight = '';
    if (animal.weights && animal.weights.length > 0) {
      var sorted = animal.weights.slice().sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
      latestWeight = ' ‚Ä¢ Latest: ' + sorted[0].weight + 'g';
    }
    
    div.innerHTML = 
      '<div class="animal-actions">' +
      '<button class="small" onclick="event.stopPropagation(); deleteAnimal(' + animal.id + ')" style="background: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6;">üóëÔ∏è</button>' +
      '</div>' +
      '<h4>' + animal.name + '</h4>' +
      '<p><strong>Species:</strong> ' + animal.species + '</p>' +
      '<p><strong>Intake:</strong> ' + formatDate(animal.intakeDate) + ' (' + daysSinceIntake + ' days ago)</p>' +
      '<p><strong>Records:</strong> ' + (animal.weights ? animal.weights.length : 0) + ' weights, ' + (animal.healthEntries ? animal.healthEntries.length : 0) + ' health entries' + latestWeight + '</p>' +
      (animal.intakeNotes ? '<p><strong>Notes:</strong> ' + (animal.intakeNotes.length > 100 ? animal.intakeNotes.substring(0, 100) + '...' : animal.intakeNotes) + '</p>' : '') +
      '<div style="margin-top: 10px; padding: 8px; background: #e7f5e4; border-radius: 5px; font-size: 12px; color: #657a6b; text-align: center;">Click to view full record</div>';
    
    list.appendChild(div);
  });
}

function deleteAnimal(id) {
  var animal = animals.find(function(a) { return a.id == id; });
  if (!animal) return;
  
  if (!confirm('Delete ' + animal.name + '? This cannot be undone.')) return;
  
  animals = animals.filter(function(a) { return a.id != id; });
  saveData();
  renderAnimals();
  updateSelects();
  
  var detailTab = document.getElementById('animalDetailTab');
  if (detailTab && detailTab.classList.contains('active')) {
    showTab('home');
  }
}

function showAnimalDetail(animalId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal) return;
  
  document.querySelectorAll('.nav-tab').forEach(function(tab) { 
    tab.classList.remove('active'); 
  });
  document.querySelectorAll('.tab-content').forEach(function(content) { 
    content.classList.remove('active'); 
  });
  document.getElementById('animalDetailTab').classList.add('active');
  
  var content = document.getElementById('animalDetailContent');
  content.innerHTML = 
    '<div class="card">' +
    '<h2>' + animal.name + '</h2>' +
    '<p><strong>Species:</strong> ' + animal.species + '</p>' +
    '<p><strong>Intake:</strong> ' + formatDate(animal.intakeDate) + ' (' + Math.floor((new Date() - new Date(animal.intakeDate)) / (1000 * 60 * 60 * 24)) + ' days ago)</p>' +
    (animal.intakeNotes ? '<p><strong>Intake Notes:</strong> ' + animal.intakeNotes + '</p>' : '') +
    '</div>' +
    '<div class="card">' +
    '<h3>Care Management</h3>' +
    '<p>Full care management features will be available in the next update. This includes:</p>' +
    '<ul>' +
    '<li>Weight tracking and feed calculations</li>' +
    '<li>Health condition monitoring</li>' +
    '<li>Treatment and medication logging</li>' +
    '<li>Daily feeding checklists</li>' +
    '<li>Custom feeding schedules</li>' +
    '<li>Photo gallery</li>' +
    '</ul>' +
    '</div>';
}

function exportAnimalData() {
  var animalId = document.getElementById('exportAnimalSelect').value;
  var animal = animals.find(function(a) { return a.id == animalId; });
  
  if (!animal) {
    alert('Please select an animal to export.');
    return;
  }
  
  var exportData = {
    animal: animal,
    exportDate: new Date().toISOString(),
    appVersion: 'BushBuddy v2.0'
  };
  
  var dataStr = JSON.stringify(exportData, null, 2);
  var dataBlob = new Blob([dataStr], {type: 'application/json'});
  
  var link = document.createElement('a');
  link.href = URL.createObjectURL(dataBlob);
  link.download = animal.name.replace(/[^a-z0-9]/gi, '_') + '_care_data.json';
  link.click();
}

function exportAllData() {
  if (animals.length === 0) {
    alert('No data to export.');
    return;
  }
  
  var exportData = {
    animals: animals,
    exportDate: new Date().toISOString(),
    appVersion: 'BushBuddy v2.0'
  };
  
  var dataStr = JSON.stringify(exportData, null, 2);
  var dataBlob = new Blob([dataStr], {type: 'application/json'});
  
  var link = document.createElement('a');
  link.href = URL.createObjectURL(dataBlob);
  link.download = 'bushbuddy_backup_' + new Date().toISOString().split('T')[0] + '.json';
  link.click();
}

function restoreData() {
  var fileInput = document.getElementById('restoreInput');
  var file = fileInput.files[0];
  
  if (!file) {
    alert('Please select a backup file to restore.');
    return;
  }
  
  if (!confirm('Restore data from backup? This will replace all current data.')) {
    return;
  }
  
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var importData = JSON.parse(e.target.result);
      
      if (importData.animals) {
        animals = importData.animals;
      } else if (importData.animal) {
        var existingIndex = animals.findIndex(function(a) { return a.id === importData.animal.id; });
        if (existingIndex >= 0) {
          animals[existingIndex] = importData.animal;
        } else {
          animals.push(importData.animal);
        }
      } else {
        throw new Error('Invalid backup file format');
      }
      
      saveData();
      renderAnimals();
      updateSelects();
      alert('Data restored successfully!');
      
    } catch (error) {
      console.error('Error importing data:', error);
      alert('Error reading backup file. Please check the file format.');
    }
  };
  
  reader.readAsText(file);
  fileInput.value = '';
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initApp);
} else {
  initApp();
}
</script>

</body>
</html>
