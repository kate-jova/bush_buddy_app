<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#698167">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="BushBuddy">
  <link rel="apple-touch-icon" href="icon-192.png">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BushBuddy</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      margin: 0; 
      padding: 20px; 
      background: linear-gradient(135deg, #f5f7fa 0%, #e7f5e4 100%); 
      min-height: 100vh; 
    }
    
    .container { max-width: 1200px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 30px; color: #657a6b; }

    .main-nav { 
      display: flex; 
      justify-content: flex-start;
      margin-bottom: 30px; 
      background: white; 
      border-radius: 15px; 
      padding: 10px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.1); 
      overflow-x: auto; 
      overflow-y: hidden;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
      scrollbar-color: #698167 #f1f1f1;
    }

    .main-nav::-webkit-scrollbar { height: 6px; }
    .main-nav::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 3px; }
    .main-nav::-webkit-scrollbar-thumb { background: #698167; border-radius: 3px; }

    .nav-tab { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      padding: 12px 16px; 
      margin: 0 4px; 
      border: none; 
      background: transparent; 
      color: #666; 
      cursor: pointer; 
      border-radius: 10px; 
      transition: all 0.3s ease; 
      font-weight: 600; 
      min-width: 80px; 
      font-size: 12px; 
      flex-shrink: 0;
      white-space: nowrap;
    }
    
    .nav-tab-icon { font-size: 20px; margin-bottom: 4px; }
    .nav-tab-text { font-size: 11px; text-align: center; line-height: 1.2; }
    .nav-tab:hover { background: rgba(43,122,120,0.1); color: #657a6b; }
    .nav-tab.active { background: linear-gradient(135deg, #698167, #a0b2af); color: white; box-shadow: 0 4px 15px rgba(43,122,120,0.3); }

    .card { 
      background: white; 
      padding: 25px; 
      border-radius: 20px; 
      box-shadow: 0 10px 40px rgba(0,0,0,0.1); 
      margin-bottom: 25px; 
    }
    
    .card h2 { margin-top: 0; color: #698167; font-size: 1.8em; }
    .card h3 { color: #698167; font-size: 1.4em; }

    label { display: block; margin-top: 15px; font-weight: 600; color: #555; }
    input, select, textarea { 
      width: 100%; 
      padding: 12px; 
      margin-top: 6px; 
      border-radius: 10px; 
      border: 2px solid #e1e8ed; 
      box-sizing: border-box; 
      font-size: 16px; 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    }
    
    input:focus, select:focus, textarea:focus { 
      outline: none; 
      border-color: #698167; 
      box-shadow: 0 0 0 3px rgba(43,122,120,0.1); 
    }
    
    textarea { resize: vertical; min-height: 80px; }

    button { 
      margin: 8px 4px; 
      padding: 12px 20px; 
      border: none; 
      border-radius: 10px; 
      background: linear-gradient(135deg, #698167, #a0b2af); 
      color: white; 
      cursor: pointer; 
      font-weight: 600; 
      transition: all 0.3s ease; 
      min-height: 44px; 
      font-size: 14px; 
    }
    
    button:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 6px 20px rgba(43,122,120,0.3); 
    }
    
    button.small { 
      padding: 8px 12px; 
      font-size: 12px; 
      margin: 2px; 
      min-height: 36px; 
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .animal-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
      gap: 20px; 
      margin-top: 20px; 
    }
    
    .animal-item { 
      background: white; 
      padding: 20px; 
      border-radius: 15px; 
      box-shadow: 0 6px 25px rgba(0,0,0,0.1); 
      position: relative; 
      cursor: pointer; 
      transition: all 0.3s ease; 
    }
    
    .animal-item:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 8px 30px rgba(0,0,0,0.15); 
    }
    
    .animal-item h4 { margin-top: 0; color: #698167; }
    .animal-actions { position: absolute; top: 15px; right: 15px; display: flex; gap: 5px; }

    .result { 
      margin-top: 15px; 
      padding: 15px; 
      border-radius: 12px; 
      background: linear-gradient(135deg, #f8f9fa, #e9ecef); 
      border-left: 4px solid #698167; 
    }

    .feeding-schedule-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .feeding-time-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 12px;
      border: 2px solid #e9ecef;
      position: relative;
      transition: all 0.3s ease;
    }

    .feeding-time-card:hover {
      border-color: #698167;
      transform: translateY(-2px);
    }

    .feeding-time-card.completed {
      background: #d4edda;
      border-color: #c3e6cb;
    }

    .feeding-time-card.overdue {
      background: #f8d7da;
      border-color: #f5c6cb;
    }

    .feeding-time-card.upcoming {
      background: #fff3cd;
      border-color: #ffeaa7;
    }

    .feeding-time-header {
      margin-bottom: 15px;
    }

    .feeding-time-main {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 10px;
    }

    .feeding-time-info {
      flex: 1;
      min-width: 0;
    }

    .feeding-time-controls {
      display: flex;
      flex-direction: column;
      gap: 5px;
      align-items: flex-end;
    }

    .feeding-time-select {
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      font-weight: bold;
      background: white;
      min-width: 100px;
    }

    .feeding-description {
      border: none;
      background: transparent;
      font-size: 13px;
      color: #666;
      padding: 2px 0;
      width: 100%;
      margin-top: 5px;
    }

    .feeding-description:focus {
      outline: none;
      background: rgba(255,255,255,0.8);
      border-radius: 3px;
      padding: 4px;
    }

    .feeding-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .feeding-actions button {
      flex: 1;
      min-width: 80px;
      padding: 8px 12px;
      font-size: 13px;
      margin: 0;
    }

    .notes-preview {
      margin: 8px 0;
      padding: 8px 10px;
      background: rgba(40, 167, 69, 0.1);
      border-left: 3px solid #28a745;
      border-radius: 4px;
      font-size: 12px;
      line-height: 1.3;
    }

    .status-badge {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .notes-button {
      background: transparent !important;
      border: 1px solid;
      padding: 6px 8px !important;
      font-size: 16px !important;
      min-width: auto !important;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 !important;
    }

    .health-entry-card {
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 15px;
      border-left: 4px solid #698167;
    }

    .health-entry-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
    }

    .health-entry-date {
      font-weight: bold;
      color: #698167;
      font-size: 14px;
    }

    .health-entry-time {
      font-size: 12px;
      color: #666;
    }

    .health-entry-type {
      padding: 4px 8px;
      border-radius: 15px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .health-type-observation { background: #e3f2fd; color: #1565c0; }
    .health-type-concern { background: #fff3e0; color: #ef6c00; }
    .health-type-improvement { background: #e8f5e8; color: #2e7d32; }
    .health-type-medication { background: #f3e5f5; color: #7b1fa2; }
    .health-type-vet-visit { background: #ffebee; color: #c62828; }

    .health-entry-content {
      margin: 10px 0;
      line-height: 1.4;
    }

    .health-entry-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .health-quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }

    .quick-action-btn {
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      background: white;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
      font-size: 13px;
      line-height: 1.3;
    }

    .quick-action-btn:hover {
      border-color: #698167;
      background: #f8f9fa;
    }

    .health-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }

    .health-summary-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      border: 1px solid #e9ecef;
    }

    .health-summary-number {
      font-size: 20px;
      font-weight: bold;
      color: #698167;
    }

    .health-summary-label {
      font-size: 11px;
      color: #666;
      margin-top: 5px;
      text-transform: uppercase;
    }

function showHealthSection(animal, container) {
  var card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = '<h3>Health Tracking for ' + animal.name + '</h3>';
  
  // Initialize health entries if they don't exist
  if (!animal.healthEntries) {
    animal.healthEntries = [];
  }
  
  // Health summary
  var summaryDiv = document.createElement('div');
  summaryDiv.className = 'health-summary-grid';
  summaryDiv.id = 'healthSummary-' + animal.id;
  card.appendChild(summaryDiv);
  
  // Quick action buttons
  var quickActionsDiv = document.createElement('div');
  quickActionsDiv.className = 'health-quick-actions';
  quickActionsDiv.innerHTML = 
    '<button class="quick-action-btn" onclick="addQuickHealthEntry(' + animal.id + ', \'observation\')">' +
    '<div style="font-size: 16px; margin-bottom: 4px;">👁️</div>' +
    'Daily Observation' +
    '</button>' +
    '<button class="quick-action-btn" onclick="addQuickHealthEntry(' + animal.id + ', \'concern\')">' +
    '<div style="font-size: 16px; margin-bottom: 4px;">⚠️</div>' +
    'Health Concern' +
    '</button>' +
    '<button class="quick-action-btn" onclick="addQuickHealthEntry(' + animal.id + ', \'improvement\')">' +
    '<div style="font-size: 16px; margin-bottom: 4px;">✅</div>' +
    'Improvement' +
    '</button>' +
    '<button class="quick-action-btn" onclick="addQuickHealthEntry(' + animal.id + ', \'medication\')">' +
    '<div style="font-size: 16px; margin-bottom: 4px;">💊</div>' +
    'Medication Given' +
    '</button>' +
    '<button class="quick-action-btn" onclick="addQuickHealthEntry(' + animal.id + ', \'vet-visit\')">' +
    '<div style="font-size: 16px; margin-bottom: 4px;">🏥</div>' +
    'Vet Visit' +
    '</button>' +
    '<button class="quick-action-btn" onclick="showAddHealthEntryModal(' + animal.id + ')">' +
    '<div style="font-size: 16px; margin-bottom: 4px;">➕</div>' +
    'Custom Entry' +
    '</button>';
  card.appendChild(quickActionsDiv);
  
  // Health entries list
  var entriesDiv = document.createElement('div');
  entriesDiv.id = 'healthEntries-' + animal.id;
  card.appendChild(entriesDiv);
  
  container.appendChild(card);
  
  // Call updateHealthDisplay after a small delay to ensure DOM is ready
  setTimeout(function() {
    updateHealthDisplay(animal);
  }, 10);
}

function updateHealthDisplay(animal) {
  var summaryDiv = document.getElementById('healthSummary-' + animal.id);
  var entriesDiv = document.getElementById('healthEntries-' + animal.id);
  
  if (!summaryDiv || !entriesDiv) return;
  
  // Calculate summary stats
  var totalEntries = animal.healthEntries ? animal.healthEntries.length : 0;
  var recentEntries = getRecentHealthEntries(animal, 7).length;
  var concerns = animal.healthEntries ? animal.healthEntries.filter(function(entry) { 
    return entry.type === 'concern' && isRecentEntry(entry.date, 7); 
  }).length : 0;
  var lastEntry = totalEntries > 0 ? calculateDaysSince(animal.healthEntries[0].date) : 'Never';
  
  // Update summary
  summaryDiv.innerHTML = 
    '<div class="health-summary-card">' +
    '<div class="health-summary-number">' + totalEntries + '</div>' +
    '<div class="health-summary-label">Total Entries</div>' +
    '</div>' +
    '<div class="health-summary-card">' +
    '<div class="health-summary-number">' + recentEntries + '</div>' +
    '<div class="health-summary-label">This Week</div>' +
    '</div>' +
    '<div class="health-summary-card">' +
    '<div class="health-summary-number">' + concerns + '</div>' +
    '<div class="health-summary-label">Active Concerns</div>' +
    '</div>' +
    '<div class="health-summary-card">' +
    '<div class="health-summary-number">' + (typeof lastEntry === 'number' ? lastEntry + 'd' : lastEntry) + '</div>' +
    '<div class="health-summary-label">Last Entry</div>' +
    '</div>';
  
  // Update entries list
  entriesDiv.innerHTML = '<h4 style="margin: 20px 0 15px 0; color: #698167;">Health History</h4>';
  
  if (!animal.healthEntries || animal.healthEntries.length === 0) {
    entriesDiv.innerHTML += '<p style="text-align: center; color: #666; font-style: italic; margin: 30px 0;">No health entries yet. Use the buttons above to start tracking health observations.</p>';
    return;
  }
  
  // Sort entries by date (newest first)
  var sortedEntries = animal.healthEntries.slice().sort(function(a, b) {
    return new Date(b.date + 'T' + (b.time || '00:00')) - new Date(a.date + 'T' + (a.time || '00:00'));
  });
}

function getRecentHealthEntries(animal, days) {
  if (!animal.healthEntries) return [];
  var cutoffDate = new Date();
  cutoffDate.setDate(cutoffDate.getDate() - days);
  
  return animal.healthEntries.filter(function(entry) {
    return new Date(entry.date) >= cutoffDate;
  });
}

function isRecentEntry(dateStr, days) {
  var cutoffDate = new Date();
  cutoffDate.setDate(cutoffDate.getDate() - days);
  return new Date(dateStr) >= cutoffDate;
}

function calculateDaysSince(dateStr) {
  var entryDate = new Date(dateStr);
  var today = new Date();
  var diffTime = today - entryDate;
  return Math.floor(diffTime / (1000 * 60 * 60 * 24));
}

function getHealthTypeLabel(type) {
  var labels = {
    'observation': 'Observation',
    'concern': 'Concern',
    'improvement': 'Improvement',
    'medication': 'Medication',
    'vet-visit': 'Vet Visit'
  };
  return labels[type] || 'Other';
}

function addQuickHealthEntry(animalId, type) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal) return;
  
  var prompts = {
    'observation': 'Record daily observation (behavior, appetite, activity level, etc.):',
    'concern': 'Describe the health concern or symptom observed:',
    'improvement': 'Describe the improvement or positive change:',
    'medication': 'Record medication given (name, dose, time):',
    'vet-visit': 'Record vet visit details (reason, findings, recommendations):'
  };
  
  var notes = prompt(prompts[type] || 'Enter health notes:');
  if (!notes || !notes.trim()) return;
  
  var now = new Date();
  var healthEntry = {
    id: Date.now(),
    date: now.toISOString().split('T')[0],
    time: now.toTimeString().substr(0, 5),
    type: type,
    notes: notes.trim()
  };
  
  if (!animal.healthEntries) animal.healthEntries = [];
  animal.healthEntries.push(healthEntry);
  
  saveData();
  updateHealthDisplay(animal);
}

function showAddHealthEntryModal(animalId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal) return;
  
  var now = new Date();
  var modalHtml = 
    '<div id="healthEntryModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">' +
    '<div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">' +
    '<h3 style="margin-top: 0;">Add Health Entry</h3>' +
    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">' +
    '<div><label>Date: <input type="date" id="healthEntryDate" value="' + now.toISOString().split('T')[0] + '"></label></div>' +
    '<div><label>Time: <select id="healthEntryTime">' + generateTimeOptionsWithSelected(now.toTimeString().substr(0, 5)) + '</select></label></div>' +
    '</div>' +
    '<label>Type: <select id="healthEntryType" style="margin-top: 10px;">' +
    '<option value="observation">Daily Observation</option>' +
    '<option value="concern">Health Concern</option>' +
    '<option value="improvement">Improvement</option>' +
    '<option value="medication">Medication Given</option>' +
    '<option value="vet-visit">Vet Visit</option>' +
    '</select></label>' +
    '<label>Notes: <textarea id="healthEntryNotes" placeholder="Enter detailed health notes..." style="margin-top: 15px; height: 120px;"></textarea></label>' +
    '<div style="margin-top: 20px; text-align: right;">' +
    '<button onclick="closeHealthEntryModal()" style="background: #6c757d; margin-right: 10px;">Cancel</button>' +
    '<button onclick="saveHealthEntry(' + animalId + ')">Save Entry</button>' +
    '</div>' +
    '</div>' +
    '</div>';
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeHealthEntryModal() {
  var modal = document.getElementById('healthEntryModal');
  if (modal) {
    modal.remove();
  }
}

function saveHealthEntry(animalId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal) return;
  
  var date = document.getElementById('healthEntryDate').value;
  var time = document.getElementById('healthEntryTime').value;
  var type = document.getElementById('healthEntryType').value;
  var notes = document.getElementById('healthEntryNotes').value.trim();
  
  if (!date || !type) {
    alert('Please fill in date and type.');
    return;
  }
  
  if (!notes) {
    alert('Please enter some notes for this health entry.');
    return;
  }
  
  var healthEntry = {
    id: Date.now(),
    date: date,
    time: time,
    type: type,
    notes: notes
  };
  
  if (!animal.healthEntries) animal.healthEntries = [];
  animal.healthEntries.push(healthEntry);
  
  saveData();
  updateHealthDisplay(animal);
  closeHealthEntryModal();
}

function editHealthEntry(animalId, entryId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal || !animal.healthEntries) return;
  
  var entry = animal.healthEntries.find(function(e) { return e.id === entryId; });
  if (!entry) return;
  
  var modalHtml = 
    '<div id="healthEntryModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">' +
    '<div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">' +
    '<h3 style="margin-top: 0;">Edit Health Entry</h3>' +
    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">' +
    '<div><label>Date: <input type="date" id="healthEntryDate" value="' + entry.date + '"></label></div>' +
    '<div><label>Time: <select id="healthEntryTime">' + generateTimeOptionsWithSelected(entry.time || '12:00') + '</select></label></div>' +
    '</div>' +
    '<label>Type: <select id="healthEntryType" style="margin-top: 10px;">' +
    '<option value="observation"' + (entry.type === 'observation' ? ' selected' : '') + '>Daily Observation</option>' +
    '<option value="concern"' + (entry.type === 'concern' ? ' selected' : '') + '>Health Concern</option>' +
    '<option value="improvement"' + (entry.type === 'improvement' ? ' selected' : '') + '>Improvement</option>' +
    '<option value="medication"' + (entry.type === 'medication' ? ' selected' : '') + '>Medication Given</option>' +
    '<option value="vet-visit"' + (entry.type === 'vet-visit' ? ' selected' : '') + '>Vet Visit</option>' +
    '</select></label>' +
    '<label>Notes: <textarea id="healthEntryNotes" placeholder="Enter detailed health notes..." style="margin-top: 15px; height: 120px;">' + (entry.notes || '') + '</textarea></label>' +
    '<div style="margin-top: 20px; text-align: right;">' +
    '<button onclick="closeHealthEntryModal()" style="background: #6c757d; margin-right: 10px;">Cancel</button>' +
    '<button onclick="updateHealthEntry(' + animalId + ', ' + entryId + ')">Update Entry</button>' +
    '</div>' +
    '</div>' +
    '</div>';
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function updateHealthEntry(animalId, entryId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal || !animal.healthEntries) return;
  
  var entry = animal.healthEntries.find(function(e) { return e.id === entryId; });
  if (!entry) return;
  
  var date = document.getElementById('healthEntryDate').value;
  var time = document.getElementById('healthEntryTime').value;
  var type = document.getElementById('healthEntryType').value;
  var notes = document.getElementById('healthEntryNotes').value.trim();
  
  if (!date || !type) {
    alert('Please fill in date and type.');
    return;
  }
  
  if (!notes) {
    alert('Please enter some notes for this health entry.');
    return;
  }
  
  entry.date = date;
  entry.time = time;
  entry.type = type;
  entry.notes = notes;
  
  saveData();
  updateHealthDisplay(animal);
  closeHealthEntryModal();
}

function deleteHealthEntry(animalId, entryId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal || !animal.healthEntries) return;
  
  if (!confirm('Delete this health entry? This cannot be undone.')) return;
  
  animal.healthEntries = animal.healthEntries.filter(function(e) {
    return e.id !== entryId;
  });
  
  saveData();
  updateHealthDisplay(animal);
}
  
  sortedEntries.forEach(function(entry) {
    var entryDiv = document.createElement('div');
    entryDiv.className = 'health-entry-card';
    
    var daysSince = calculateDaysSince(entry.date);
    var timeDisplay = entry.time ? formatTime(entry.time) : '';
    
    entryDiv.innerHTML = 
      '<div class="health-entry-header">' +
      '<div>' +
      '<div class="health-entry-date">' + formatDate(entry.date) + 
      (timeDisplay ? ' at ' + timeDisplay : '') + '</div>' +
      '<div class="health-entry-time">' + daysSince + ' days ago</div>' +
      '</div>' +
      '<div class="health-entry-type health-type-' + entry.type + '">' + 
      getHealthTypeLabel(entry.type) + '</div>' +
      '</div>' +
      '<div class="health-entry-content">' + 
      (entry.notes || 'No notes recorded') + '</div>' +
      '<div class="health-entry-actions">' +
      '<button class="small" onclick="editHealthEntry(' + animal.id + ', ' + entry.id + ')" style="background: #6c757d;">Edit</button>' +
      '<button class="small" onclick="deleteHealthEntry(' + animal.id + ', ' + entry.id + ')" style="background: #dc3545;">Delete</button>' +
      '</div>';
    
    entriesDiv.appendChild(entryDiv);
  });
}

function getRecentHealthEntries(animal, days) {
  if (!animal.healthEntries) return [];
  var cutoffDate = new Date();
  cutoffDate.setDate(cutoffDate.getDate() - days);
  
  return animal.healthEntries.filter(function(entry) {
    return new Date(entry.date) >= cutoffDate;
  });
}

function isRecentEntry(dateStr, days) {
  var cutoffDate = new Date();
  cutoffDate.setDate(cutoffDate.getDate() - days);
  return new Date(dateStr) >= cutoffDate;
}

function calculateDaysSince(dateStr) {
  var entryDate = new Date(dateStr);
  var today = new Date();
  var diffTime = today - entryDate;
  return Math.floor(diffTime / (1000 * 60 * 60 * 24));
}

function getHealthTypeLabel(type) {
  var labels = {
    'observation': 'Observation',
    'concern': 'Concern',
    'improvement': 'Improvement',
    'medication': 'Medication',
    'vet-visit': 'Vet Visit'
  };
  return labels[type] || 'Other';
}

function addQuickHealthEntry(animalId, type) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal) return;
  
  var prompts = {
    'observation': 'Record daily observation (behavior, appetite, activity level, etc.):',
    'concern': 'Describe the health concern or symptom observed:',
    'improvement': 'Describe the improvement or positive change:',
    'medication': 'Record medication given (name, dose, time):',
    'vet-visit': 'Record vet visit details (reason, findings, recommendations):'
  };
  
  var notes = prompt(prompts[type] || 'Enter health notes:');
  if (!notes || !notes.trim()) return;
  
  var now = new Date();
  var healthEntry = {
    id: Date.now(),
    date: now.toISOString().split('T')[0],
    time: now.toTimeString().substr(0, 5),
    type: type,
    notes: notes.trim()
  };
  
  if (!animal.healthEntries) animal.healthEntries = [];
  animal.healthEntries.push(healthEntry);
  
  saveData();
  updateHealthDisplay(animal);
}

function showAddHealthEntryModal(animalId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal) return;
  
  var now = new Date();
  var modalHtml = 
    '<div id="healthEntryModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">' +
    '<div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">' +
    '<h3 style="margin-top: 0;">Add Health Entry</h3>' +
    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">' +
    '<div><label>Date: <input type="date" id="healthEntryDate" value="' + now.toISOString().split('T')[0] + '"></label></div>' +
    '<div><label>Time: <select id="healthEntryTime">' + generateTimeOptionsWithSelected(now.toTimeString().substr(0, 5)) + '</select></label></div>' +
    '</div>' +
    '<label>Type: <select id="healthEntryType" style="margin-top: 10px;">' +
    '<option value="observation">Daily Observation</option>' +
    '<option value="concern">Health Concern</option>' +
    '<option value="improvement">Improvement</option>' +
    '<option value="medication">Medication Given</option>' +
    '<option value="vet-visit">Vet Visit</option>' +
    '</select></label>' +
    '<label>Notes: <textarea id="healthEntryNotes" placeholder="Enter detailed health notes..." style="margin-top: 15px; height: 120px;"></textarea></label>' +
    '<div style="margin-top: 20px; text-align: right;">' +
    '<button onclick="closeHealthEntryModal()" style="background: #6c757d; margin-right: 10px;">Cancel</button>' +
    '<button onclick="saveHealthEntry(' + animalId + ')">Save Entry</button>' +
    '</div>' +
    '</div>' +
    '</div>';
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeHealthEntryModal() {
  var modal = document.getElementById('healthEntryModal');
  if (modal) {
    modal.remove();
  }
}

function saveHealthEntry(animalId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal) return;
  
  var date = document.getElementById('healthEntryDate').value;
  var time = document.getElementById('healthEntryTime').value;
  var type = document.getElementById('healthEntryType').value;
  var notes = document.getElementById('healthEntryNotes').value.trim();
  
  if (!date || !type) {
    alert('Please fill in date and type.');
    return;
  }
  
  if (!notes) {
    alert('Please enter some notes for this health entry.');
    return;
  }
  
  var healthEntry = {
    id: Date.now(),
    date: date,
    time: time,
    type: type,
    notes: notes
  };
  
  if (!animal.healthEntries) animal.healthEntries = [];
  animal.healthEntries.push(healthEntry);
  
  saveData();
  updateHealthDisplay(animal);
  closeHealthEntryModal();
}

function editHealthEntry(animalId, entryId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal || !animal.healthEntries) return;
  
  var entry = animal.healthEntries.find(function(e) { return e.id === entryId; });
  if (!entry) return;
  
  var modalHtml = 
    '<div id="healthEntryModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">' +
    '<div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">' +
    '<h3 style="margin-top: 0;">Edit Health Entry</h3>' +
    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">' +
    '<div><label>Date: <input type="date" id="healthEntryDate" value="' + entry.date + '"></label></div>' +
    '<div><label>Time: <select id="healthEntryTime">' + generateTimeOptionsWithSelected(entry.time || '12:00') + '</select></label></div>' +
    '</div>' +
    '<label>Type: <select id="healthEntryType" style="margin-top: 10px;">' +
    '<option value="observation"' + (entry.type === 'observation' ? ' selected' : '') + '>Daily Observation</option>' +
    '<option value="concern"' + (entry.type === 'concern' ? ' selected' : '') + '>Health Concern</option>' +
    '<option value="improvement"' + (entry.type === 'improvement' ? ' selected' : '') + '>Improvement</option>' +
    '<option value="medication"' + (entry.type === 'medication' ? ' selected' : '') + '>Medication Given</option>' +
    '<option value="vet-visit"' + (entry.type === 'vet-visit' ? ' selected' : '') + '>Vet Visit</option>' +
    '</select></label>' +
    '<label>Notes: <textarea id="healthEntryNotes" placeholder="Enter detailed health notes..." style="margin-top: 15px; height: 120px;">' + (entry.notes || '') + '</textarea></label>' +
    '<div style="margin-top: 20px; text-align: right;">' +
    '<button onclick="closeHealthEntryModal()" style="background: #6c757d; margin-right: 10px;">Cancel</button>' +
    '<button onclick="updateHealthEntry(' + animalId + ', ' + entryId + ')">Update Entry</button>' +
    '</div>' +
    '</div>' +
    '</div>';
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function updateHealthEntry(animalId, entryId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal || !animal.healthEntries) return;
  
  var entry = animal.healthEntries.find(function(e) { return e.id === entryId; });
  if (!entry) return;
  
  var date = document.getElementById('healthEntryDate').value;
  var time = document.getElementById('healthEntryTime').value;
  var type = document.getElementById('healthEntryType').value;
  var notes = document.getElementById('healthEntryNotes').value.trim();
  
  if (!date || !type) {
    alert('Please fill in date and type.');
    return;
  }
  
  if (!notes) {
    alert('Please enter some notes for this health entry.');
    return;
  }
  
  entry.date = date;
  entry.time = time;
  entry.type = type;
  entry.notes = notes;
  
  saveData();
  updateHealthDisplay(animal);
  closeHealthEntryModal();
}

function deleteHealthEntry(animalId, entryId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal || !animal.healthEntries) return;
  
  if (!confirm('Delete this health entry? This cannot be undone.')) return;
  
  animal.healthEntries = animal.healthEntries.filter(function(e) {
    return e.id !== entryId;
  });
  
  saveData();
  updateHealthDisplay(animal);
}
}

function updateHealthDisplay(animal) {
  var summaryDiv = document.getElementById('healthSummary-' + animal.id);
  var entriesDiv = document.getElementById('healthEntries-' + animal.id);
  
  if (!summaryDiv || !entriesDiv) return;
  
  // Calculate summary stats
  var totalEntries = animal.healthEntries ? animal.healthEntries.length : 0;
  var recentEntries = getRecentHealthEntries(animal, 7).length;
  var concerns = animal.healthEntries ? animal.healthEntries.filter(function(entry) { 
    return entry.type === 'concern' && isRecentEntry(entry.date, 7); 
  }).length : 0;
  var lastEntry = totalEntries > 0 ? calculateDaysSince(animal.healthEntries[0].date) : 'Never';
  
  // Update summary
  summaryDiv.innerHTML = 
    '<div class="health-summary-card">' +
    '<div class="health-summary-number">' + totalEntries + '</div>' +
    '<div class="health-summary-label">Total Entries</div>' +
    '</div>' +
    '<div class="health-summary-card">' +
    '<div class="health-summary-number">' + recentEntries + '</div>' +
    '<div class="health-summary-label">This Week</div>' +
    '</div>' +
    '<div class="health-summary-card">' +
    '<div class="health-summary-number">' + concerns + '</div>' +
    '<div class="health-summary-label">Active Concerns</div>' +
    '</div>' +
    '<div class="health-summary-card">' +
    '<div class="health-summary-number">' + (typeof lastEntry === 'number' ? lastEntry + 'd' : lastEntry) + '</div>' +
    '<div class="health-summary-label">Last Entry</div>' +
    '</div>';
  
  // Update entries list
  entriesDiv.innerHTML = '<h4 style="margin: 20px 0 15px 0; color: #698167;">Health History</h4>';
  
  if (!animal.healthEntries || animal.healthEntries.length === 0) {
    entriesDiv.innerHTML += '<p style="text-align: center; color: #666; font-style: italic; margin: 30px 0;">No health entries yet. Use the buttons above to start tracking health observations.</p>';
    return;
  }
  
  // Sort entries by date (newest first)
  var sortedEntries = animal.healthEntries.slice().sort(function(a, b) {
    return new Date(b.date + 'T' + (b.time || '00:00')) - new Date(a.date + 'T' + (a.time || '00:00'));
  });
  
  sortedEntries.forEach(function(entry) {
    var entryDiv = document.createElement('div');
    entryDiv.className = 'health-entry-card';
    
    var daysSince = calculateDaysSince(entry.date);
    var timeDisplay = entry.time ? formatTime(entry.time) : '';
    
    entryDiv.innerHTML = 
      '<div class="health-entry-header">' +
      '<div>' +
      '<div class="health-entry-date">' + formatDate(entry.date) + 
      (timeDisplay ? ' at ' + timeDisplay : '') + '</div>' +
      '<div class="health-entry-time">' + daysSince + ' days ago</div>' +
      '</div>' +
      '<div class="health-entry-type health-type-' + entry.type + '">' + 
      getHealthTypeLabel(entry.type) + '</div>' +
      '</div>' +
      '<div class="health-entry-content">' + 
      (entry.notes || 'No notes recorded') + '</div>' +
      '<div class="health-entry-actions">' +
      '<button class="small" onclick="editHealthEntry(' + animal.id + ', ' + entry.id + ')" style="background: #6c757d;">Edit</button>' +
      '<button class="small" onclick="deleteHealthEntry(' + animal.id + ', ' + entry.id + ')" style="background: #dc3545;">Delete</button>' +
      '</div>';
    
    entriesDiv.appendChild(entryDiv);
  });
}

function getRecentHealthEntries(animal, days) {
  if (!animal.healthEntries) return [];
  var cutoffDate = new Date();
  cutoffDate.setDate(cutoffDate.getDate() - days);
  
  return animal.healthEntries.filter(function(entry) {
    return new Date(entry.date) >= cutoffDate;
  });
}

function isRecentEntry(dateStr, days) {
  var cutoffDate = new Date();
  cutoffDate.setDate(cutoffDate.getDate() - days);
  return new Date(dateStr) >= cutoffDate;
}

function calculateDaysSince(dateStr) {
  var entryDate = new Date(dateStr);
  var today = new Date();
  var diffTime = today - entryDate;
  return Math.floor(diffTime / (1000 * 60 * 60 * 24));
}

function getHealthTypeLabel(type) {
  var labels = {
    'observation': 'Observation',
    'concern': 'Concern',
    'improvement': 'Improvement',
    'medication': 'Medication',
    'vet-visit': 'Vet Visit'
  };
  return labels[type] || 'Other';
}

function addQuickHealthEntry(animalId, type) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal) return;
  
  var prompts = {
    'observation': 'Record daily observation (behavior, appetite, activity level, etc.):',
    'concern': 'Describe the health concern or symptom observed:',
    'improvement': 'Describe the improvement or positive change:',
    'medication': 'Record medication given (name, dose, time):',
    'vet-visit': 'Record vet visit details (reason, findings, recommendations):'
  };
  
  var notes = prompt(prompts[type] || 'Enter health notes:');
  if (!notes || !notes.trim()) return;
  
  var now = new Date();
  var healthEntry = {
    id: Date.now(),
    date: now.toISOString().split('T')[0],
    time: now.toTimeString().substr(0, 5),
    type: type,
    notes: notes.trim()
  };
  
  if (!animal.healthEntries) animal.healthEntries = [];
  animal.healthEntries.push(healthEntry);
  
  saveData();
  updateHealthDisplay(animal);
}

function showAddHealthEntryModal(animalId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal) return;
  
  var now = new Date();
  var modalHtml = 
    '<div id="healthEntryModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">' +
    '<div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">' +
    '<h3 style="margin-top: 0;">Add Health Entry</h3>' +
    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">' +
    '<div><label>Date: <input type="date" id="healthEntryDate" value="' + now.toISOString().split('T')[0] + '"></label></div>' +
    '<div><label>Time: <select id="healthEntryTime">' + generateTimeOptionsWithSelected(now.toTimeString().substr(0, 5)) + '</select></label></div>' +
    '</div>' +
    '<label>Type: <select id="healthEntryType" style="margin-top: 10px;">' +
    '<option value="observation">Daily Observation</option>' +
    '<option value="concern">Health Concern</option>' +
    '<option value="improvement">Improvement</option>' +
    '<option value="medication">Medication Given</option>' +
    '<option value="vet-visit">Vet Visit</option>' +
    '</select></label>' +
    '<label>Notes: <textarea id="healthEntryNotes" placeholder="Enter detailed health notes..." style="margin-top: 15px; height: 120px;"></textarea></label>' +
    '<div style="margin-top: 20px; text-align: right;">' +
    '<button onclick="closeHealthEntryModal()" style="background: #6c757d; margin-right: 10px;">Cancel</button>' +
    '<button onclick="saveHealthEntry(' + animalId + ')">Save Entry</button>' +
    '</div>' +
    '</div>' +
    '</div>';
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeHealthEntryModal() {
  var modal = document.getElementById('healthEntryModal');
  if (modal) {
    modal.remove();
  }
}

function saveHealthEntry(animalId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal) return;
  
  var date = document.getElementById('healthEntryDate').value;
  var time = document.getElementById('healthEntryTime').value;
  var type = document.getElementById('healthEntryType').value;
  var notes = document.getElementById('healthEntryNotes').value.trim();
  
  if (!date || !type) {
    alert('Please fill in date and type.');
    return;
  }
  
  if (!notes) {
    alert('Please enter some notes for this health entry.');
    return;
  }
  
  var healthEntry = {
    id: Date.now(),
    date: date,
    time: time,
    type: type,
    notes: notes
  };
  
  if (!animal.healthEntries) animal.healthEntries = [];
  animal.healthEntries.push(healthEntry);
  
  saveData();
  updateHealthDisplay(animal);
  closeHealthEntryModal();
}

function editHealthEntry(animalId, entryId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal || !animal.healthEntries) return;
  
  var entry = animal.healthEntries.find(function(e) { return e.id === entryId; });
  if (!entry) return;
  
  var modalHtml = 
    '<div id="healthEntryModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">' +
    '<div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">' +
    '<h3 style="margin-top: 0;">Edit Health Entry</h3>' +
    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">' +
    '<div><label>Date: <input type="date" id="healthEntryDate" value="' + entry.date + '"></label></div>' +
    '<div><label>Time: <select id="healthEntryTime">' + generateTimeOptionsWithSelected(entry.time || '12:00') + '</select></label></div>' +
    '</div>' +
    '<label>Type: <select id="healthEntryType" style="margin-top: 10px;">' +
    '<option value="observation"' + (entry.type === 'observation' ? ' selected' : '') + '>Daily Observation</option>' +
    '<option value="concern"' + (entry.type === 'concern' ? ' selected' : '') + '>Health Concern</option>' +
    '<option value="improvement"' + (entry.type === 'improvement' ? ' selected' : '') + '>Improvement</option>' +
    '<option value="medication"' + (entry.type === 'medication' ? ' selected' : '') + '>Medication Given</option>' +
    '<option value="vet-visit"' + (entry.type === 'vet-visit' ? ' selected' : '') + '>Vet Visit</option>' +
    '</select></label>' +
    '<label>Notes: <textarea id="healthEntryNotes" placeholder="Enter detailed health notes..." style="margin-top: 15px; height: 120px;">' + (entry.notes || '') + '</textarea></label>' +
    '<div style="margin-top: 20px; text-align: right;">' +
    '<button onclick="closeHealthEntryModal()" style="background: #6c757d; margin-right: 10px;">Cancel</button>' +
    '<button onclick="updateHealthEntry(' + animalId + ', ' + entryId + ')">Update Entry</button>' +
    '</div>' +
    '</div>' +
    '</div>';
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function updateHealthEntry(animalId, entryId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal || !animal.healthEntries) return;
  
  var entry = animal.healthEntries.find(function(e) { return e.id === entryId; });
  if (!entry) return;
  
  var date = document.getElementById('healthEntryDate').value;
  var time = document.getElementById('healthEntryTime').value;
  var type = document.getElementById('healthEntryType').value;
  var notes = document.getElementById('healthEntryNotes').value.trim();
  
  if (!date || !type) {
    alert('Please fill in date and type.');
    return;
  }
  
  if (!notes) {
    alert('Please enter some notes for this health entry.');
    return;
  }
  
  entry.date = date;
  entry.time = time;
  entry.type = type;
  entry.notes = notes;
  
  saveData();
  updateHealthDisplay(animal);
  closeHealthEntryModal();
}

function deleteHealthEntry(animalId, entryId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal || !animal.healthEntries) return;
  
  if (!confirm('Delete this health entry? This cannot be undone.')) return;
  
  animal.healthEntries = animal.healthEntries.filter(function(e) {
    return e.id !== entryId;
  });
  
  saveData();
  updateHealthDisplay(animal);
}

/* Mobile optimizations */
    @media (max-width: 768px) {
      .health-quick-actions {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }
      
      .quick-action-btn {
        padding: 10px;
        font-size: 12px;
      }
      
      .health-summary-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }
      
      .health-summary-card {
        padding: 12px;
      }
      
      .health-entry-header {
        flex-direction: column;
        gap: 8px;
      }
    }
    @media (max-width: 768px) {
      .feeding-schedule-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .feeding-time-card {
        padding: 12px;
      }
      
      .feeding-time-main {
        gap: 10px;
      }
      
      .feeding-time-controls {
        flex-direction: row;
        align-items: center;
        gap: 8px;
      }
      
      .feeding-time-select {
        font-size: 14px;
        min-width: 90px;
      }
      
      .feeding-actions {
        gap: 6px;
      }
      
      .feeding-actions button {
        font-size: 12px;
        padding: 8px 10px;
        min-width: 70px;
      }
      
      .schedule-summary {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }
      
      .summary-card {
        padding: 12px;
      }
      
      .summary-number {
        font-size: 20px;
      }
    }

    @media (max-width: 480px) {
      .feeding-time-main {
        flex-direction: column;
        gap: 8px;
      }
      
      .feeding-time-controls {
        flex-direction: row;
        align-self: stretch;
        justify-content: space-between;
      }
      
      .feeding-time-select {
        min-width: 120px;
      }
    }

    .status-completed { background: #28a745; color: white; }
    .status-overdue { background: #dc3545; color: white; }
    .status-upcoming { background: #ffc107; color: #212529; }
    .status-pending { background: #6c757d; color: white; }

    .schedule-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }

    .summary-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      border: 2px solid #e9ecef;
    }

    .summary-number {
      font-size: 24px;
      font-weight: bold;
      color: #698167;
    }

    .summary-label {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <img src="BushBuddy.png" alt="BushBuddy Logo" style="max-height: 120px; max-width: 100%; height: auto;">
  </div>

  <div class="main-nav">
    <button class="nav-tab active" onclick="showTab('home')">
      <div class="nav-tab-icon">🏠</div>
      <div class="nav-tab-text">Home</div>
    </button>
    <button class="nav-tab" onclick="showTab('add')">
      <div class="nav-tab-icon">➕</div>
      <div class="nav-tab-text">Add New<br>Animal</div>
    </button>
    <button class="nav-tab" onclick="showTab('export')">
      <div class="nav-tab-icon">📋</div>
      <div class="nav-tab-text">Backup &<br>Export</div>
    </button>
  </div>

  <!-- Home Tab -->
  <div id="homeTab" class="tab-content active">
    <div class="card">
      <h2>Your Animals</h2>
      
      <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
        <input type="text" id="animalSearch" placeholder="Search by name, species, or notes..." style="flex: 1; min-width: 200px;">
        <select id="speciesFilter" style="min-width: 200px;">
          <option value="">All Species</option>
          <option value="Common Brushtail Possum">Common Brushtail Possum</option>
          <option value="Ringtail Possum">Ringtail Possum</option>
          <option value="Short-Eared Brushtail Possum">Short-Eared Brushtail Possum</option>
        </select>
      </div>
      
      <p id="animalCounter" style="color: #666; font-size: 14px; margin-bottom: 10px;"></p>
      <div id="animalList" class="animal-grid">
        <p style="text-align: center; color: #666; font-style: italic;">No animals added yet. Add your first animal using the "Add New Animal" tab!</p>
      </div>
    </div>
  </div>

  <!-- Add New Animal Tab -->
  <div id="addTab" class="tab-content">
    <div class="card">
      <h2>Add New Animal</h2>
      <label>Name: <input type="text" id="animalName" placeholder="Enter animal name"></label>
      <label>Species: 
        <select id="animalSpecies">
          <option value="Common Brushtail Possum">Common Brushtail Possum</option>
          <option value="Ringtail Possum">Ringtail Possum</option>
          <option value="Short-Eared Brushtail Possum">Short-Eared Brushtail Possum</option>
        </select>
      </label>
      <label>Intake Date: <input type="date" id="intakeDate"></label>
      <label>Intake Notes: <textarea id="intakeNotes" placeholder="Circumstances of rescue, initial condition, etc."></textarea></label>
      <button onclick="addAnimal()">Add Animal</button>
    </div>
  </div>

  <!-- Animal Detail View -->
  <div id="animalDetailTab" class="tab-content">
    <div style="margin-bottom: 20px;">
      <button onclick="showTab('home')" style="background: #6c757d;">← Back to Animals</button>
    </div>
    <div id="animalDetailContent"></div>
  </div>

  <!-- Export Tab -->
  <div id="exportTab" class="tab-content">
    <div class="card">
      <h2>Backup & Export</h2>
      <label>Select Animal for Export: 
        <select id="exportAnimalSelect">
          <option value="">Select an animal...</option>
        </select>
      </label>
      <button onclick="exportAnimalData()">Export Care Data</button>
      
      <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 15px;">
        <h4>Backup & Restore</h4>
        <button onclick="exportAllData()">Backup All Data</button>
        <label>Restore Data: <input type="file" id="restoreInput" accept=".json"></label>
        <button onclick="restoreData()">Restore from Backup</button>
      </div>
    </div>
  </div>
</div>

<footer style="margin-top: 50px; padding: 30px 20px; background: rgba(255,255,255,0.9); border-top: 1px solid #e0e0e0; text-align: center; font-size: 12px; color: #666;">
  <div style="max-width: 1200px; margin: 0 auto;">
    <p><strong>Disclaimer:</strong> BushBuddy is a record-keeping tool designed to assist qualified wildlife carers. This application does not provide veterinary or professional wildlife care advice. Always consult with licensed wildlife veterinarians and follow established wildlife care protocols.</p>
    <p style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0;">© 2025 BushBuddy. All rights reserved.</p>
  </div>
</footer>

<script>
var animals = [];

// Add error logging for debugging
window.onerror = function(msg, url, lineNo, columnNo, error) {
  console.error('JavaScript Error:', msg, 'at line', lineNo);
  alert('JavaScript Error: ' + msg + ' (Line: ' + lineNo + ')');
  return false;
};

// Species feeding data
var speciesData = {
  "Common Brushtail Possum": [
    { weight: 1100, feeds: 1, predictedAge: "7 months", features: "Prepare to release. Must be assessed for suitability against the release criteria.", housing: "Large outdoor release aviary (min 3m x 2m x 2m). Nest box, food/ water high in aviary.", feedingNotes: "1 milk feed per day at dusk.", milkFormula: "Maximum 40mL per feed. Cease 1 week before release." },
    { weight: 500, feeds: 2, predictedAge: "5.5 - 6 months", features: "Would still cling to mother's back in wild. Should be getting very confident climbing around enclosure.", housing: "Large outdoor release aviary (min 3m x 2m x 2m). Nest box, food/ water high in aviary.", feedingNotes: "2 milk feeds per day. Offer early morning and late evening.", milkFormula: "Maximum of 40mls in a single feed. 15% of body weight divided equally over 2 feeds." },
    { weight: 400, feeds: 3, predictedAge: "5 months", features: "Dense fur. Dark pellets. Still riding on mum's back but more confident climbing.", housing: "Large cage (1m x 1m x 1.2m) or small walk-in aviary. Include nest box, water dish and branches for climbing.", feedingNotes: "3 milk feeds per day. Offer early morning, mid afternoon and late evening.", milkFormula: "Milk: 15% of body weight divided equally over 3 feeds." },
    { weight: 250, feeds: 4, predictedAge: "4.5 months", features: "Short dense fur. Soft pellets. More confident out of mum's pouch.", housing: "Variety of branches and ropes for climbing. Housed indoors. Small amount of fresh water.", feedingNotes: "4 feeds per day. Milk – 6 hourly. Lapping from shallow jar lid or small bowl.", milkFormula: "Milk: 15% of body weight divided equally over 4 feeds." },
    { weight: 150, feeds: 5, predictedAge: "4 months", features: "Fine soft fur, teeth. Darker tube-like faeces. Starting to explore outside of mum's pouch.", housing: "Carry cage with secure lid and fine mesh. Hang pouch inside with branches. Housed indoors.", feedingNotes: "5 feeds per day. Milk approximately 5 hourly. Lapping from shallow jar lid or small bowl.", milkFormula: "Milk: 15% of body weight divided equally over 5 feeds." },
    { weight: 100, feeds: 6, predictedAge: "3.5 months", features: "Cutting fur, eyes open. Thick, custard-like faeces.", housing: "Multiple pouches to form a cosy 'cave'. Plenty of fleece cloths. Housed indoors.", feedingNotes: "6 feeds per day. Milk – 4 hourly. Will usually be lapping by this stage.", milkFormula: "Milk: 15% of body weight divided equally over 6 feeds." },
    { weight: 60, feeds: 8, predictedAge: "3 months", features: "Furless, eyes closed. Custard-like faeces. Permanently in mum's pouch. Experienced carers only.", housing: "32°C. Multiple pouches forming cosy 'cave'. Watch for dehydration and diarrhoea.", feedingNotes: "6-8 feeds per day depending upon hydration. Syringe with teat until mouth membranes open.", milkFormula: "Milk: 15% of body weight divided equally over 6-8 feeds." }
  ],
  "Ringtail Possum": [
    { weight: 500, feeds: 1, predictedAge: "7.5+ months", features: "Prepare to release. Must be assessed for suitability against the release criteria.", housing: "Large outdoor release aviary (min 3m x 2m x 2m) in natural surroundings. Drey and water placed high.", feedingNotes: "1 milk feed per day at dusk. Cease 1 week before release.", milkFormula: "Maximum 30mL per feed." },
    { weight: 300, feeds: 2, predictedAge: "6 months", features: "Fully independent. Very active at night. Should be very confident climbing.", housing: "Large outdoor release aviary (min 3m x 2m x 2m) in natural surroundings. Drey and water placed high.", feedingNotes: "2 milk feeds per day. Offer early morning and late evening.", milkFormula: "Maximum of 25mls in a single feed. 15% of body weight divided equally over 2 feeds." },
    { weight: 175, feeds: 3, predictedAge: "5 months", features: "Thick fur. Dark pellets. Still riding on mum's back but more confident climbing.", housing: "Large inside cage (1m x 1m x 1.2m). Introduce drey to cage. Good variety of branches and rope.", feedingNotes: "3 milk feeds per day. Early morning, mid afternoon and late evening. Feed each ringtail separately.", milkFormula: "Milk: 15% of body weight divided equally over 3 feeds" },
    { weight: 130, feeds: 4, predictedAge: "4.5 months", features: "Fluffy fur. Dark Pellets. More confident outside of mum's pouch.", housing: "Variety of branches and ropes for climbing. Housed indoors. Small amount of fresh water.", feedingNotes: "4 feeds per day. Milk – 6 hourly. Lapping from shallow bowl. Feed each ringtail separately.", milkFormula: "Milk: 15% of body weight divided equally over 4 feeds." },
    { weight: 100, feeds: 5, predictedAge: "4 months", features: "Fine, soft, fluffy fur. Teeth. Darker tube-like faeces or pellets.", housing: "Large indoor cage (1m x 1m x 1.2m) with pouch secured up high. Variety of branches and ropes.", feedingNotes: "5 feeds per day. Milk approximately 5 hourly. Lapping from shallow jar lid or small bowl.", milkFormula: "Milk: 15% of body weight divided equally over 5 feeds." },
    { weight: 80, feeds: 6, predictedAge: "3.5 months", features: "Short fur, eyes open. Dark tube like faeces or pellets.", housing: "Carry cage with secure lid and fine mesh. Hang pouch with branches. Housed indoors.", feedingNotes: "6 feeds per day. Milk – 4 hourly. Will usually be lapping by this stage.", milkFormula: "Milk: 15% of body weight divided equally over 6 feeds." }
  ],
  "Short-Eared Brushtail Possum": [
    { weight: 1300, feeds: 1, predictedAge: "8 months", features: "Prepare to release. Must be assessed for suitability against the release criteria.", housing: "Large outdoor release aviary, (minimum 3m x 2m x 2m).", feedingNotes: "1 milk feed per day at dusk. Start weaning off milk gradually.", milkFormula: "Maximum 40mL per feed." },
    { weight: 650, feeds: 2, predictedAge: "5.6 - 6 months", features: "Would still cling to mother's back in the wild. Should be getting very confident climbing.", housing: "Large outdoor release aviary, (minimum 3m x 2m x 2m), in natural surroundings.", feedingNotes: "2 milk feeds per day. Offer early morning and late evening.", milkFormula: "Maximum of 40mls in a single feed. 15% of body weight divided equally over 2 feeds." },
    { weight: 500, feeds: 3, predictedAge: "5 months", features: "Dense fur. Dark pellets. Still riding on mum's back.", housing: "Large cage (1m x 1m x 1.2m).", feedingNotes: "3 feeds per day. Offer early morning, mid afternoon and late evening.", milkFormula: "Milk: 15% of body weight divided equally over 3 feeds" },
    { weight: 275, feeds: 4, predictedAge: "4.5 months", features: "Short dense fur. Soft pellets. More confident out of mum's pouch.", housing: "Carry cage with secure lid and fine mesh.", feedingNotes: "4 feeds per day. Milk – 6 hourly.", milkFormula: "Milk: 15% of body weight divided equally over 4 feeds." },
    { weight: 200, feeds: 5, predictedAge: "4 months", features: "Fine soft fur, teeth. Darker tube-like faeces. Exploring outside of mum's pouch.", housing: "Carry cage with secure lid and fine mesh", feedingNotes: "5 feeds per day. Milk approximately 5 hourly.", milkFormula: "Milk: 15% of body weight divided equally over 5 feeds." },
    { weight: 150, feeds: 6, predictedAge: "3.5 months", features: "Cutting fur, eyes open. Thick, custard-like faeces.", housing: "Carry cage with secure lid and fine mesh.", feedingNotes: "6 feeds per day. Milk – 4 hourly.", milkFormula: "Milk: 15% of body weight divided equally over 6 feeds." }
  ]
};

function getFeedsPerDay(weight, species) {
  var schedule = speciesData[species] || speciesData["Common Brushtail Possum"];
  for (var i = 0; i < schedule.length; i++) {
    if (weight >= schedule[i].weight) return schedule[i].feeds;
  }
  return schedule[schedule.length - 1].feeds;
}

function getAnimalInfo(weight, species) {
  var schedule = speciesData[species] || speciesData["Common Brushtail Possum"];
  for (var i = 0; i < schedule.length; i++) {
    if (weight >= schedule[i].weight) return schedule[i];
  }
  return schedule[schedule.length - 1];
}

function formatDate(dateStr) {
  if (!dateStr) return '';
  var date = new Date(dateStr);
  var day = String(date.getDate()).padStart(2, '0');
  var month = String(date.getMonth() + 1).padStart(2, '0');
  var year = date.getFullYear();
  return day + '-' + month + '-' + year;
}

function formatTime(timeStr) {
  if (!timeStr) return '';
  var time = new Date('1970-01-01T' + timeStr + ':00');
  return time.toLocaleTimeString('en-AU', { 
    hour: 'numeric', 
    minute: '2-digit', 
    hour12: true 
  });
}

function saveData() {
  try {
    var dataStr = JSON.stringify(animals);
    localStorage.setItem('bushbuddy_animals', dataStr);
    console.log('Data saved successfully');
  } catch (e) {
    console.error('Error saving data:', e);
    alert('Error saving data. Please try again.');
  }
}

function loadData() {
  try {
    var saved = localStorage.getItem('bushbuddy_animals');
    if (saved) {
      animals = JSON.parse(saved);
      console.log('Data loaded successfully:', animals.length, 'animals');
    } else {
      animals = [];
      console.log('No saved data found');
    }
  } catch (e) {
    console.error('Error loading data:', e);
    animals = [];
  }
}

function setDefaultDates() {
  var today = new Date().toISOString().split('T')[0];
  var intakeDate = document.getElementById('intakeDate');
  if (intakeDate) {
    intakeDate.value = today;
  }
}

function showTab(tabName) {
  console.log('showTab called with:', tabName);
  
  document.querySelectorAll('.nav-tab').forEach(function(tab) { 
    tab.classList.remove('active'); 
  });
  document.querySelectorAll('.tab-content').forEach(function(content) { 
    content.classList.remove('active'); 
  });
  
  // Find the clicked tab and activate it
  var clickedTab = event ? event.target.closest('.nav-tab') : document.querySelector('.nav-tab');
  if (clickedTab) {
    clickedTab.classList.add('active');
  }
  
  var targetTab = document.getElementById(tabName + 'Tab');
  if (targetTab) {
    targetTab.classList.add('active');
  }
  
  updateSelects();
}

function updateSelects() {
  var exportSelect = document.getElementById('exportAnimalSelect');
  
  if (exportSelect) {
    var currentValue = exportSelect.value;
    exportSelect.innerHTML = '<option value="">Select an animal...</option>';
    
    animals.forEach(function(animal) {
      var option = document.createElement('option');
      option.value = animal.id;
      option.textContent = animal.name + ' (' + animal.species + ')';
      exportSelect.appendChild(option);
    });
    
    if (currentValue && animals.some(function(a) { return a.id == currentValue; })) {
      exportSelect.value = currentValue;
    }
  }
}

function addAnimal() {
  console.log('addAnimal function called');
  
  var name = document.getElementById('animalName').value.trim();
  var species = document.getElementById('animalSpecies').value;
  var intakeDate = document.getElementById('intakeDate').value;
  var intakeNotes = document.getElementById('intakeNotes').value.trim();
  
  console.log('Form values:', {name: name, species: species, intakeDate: intakeDate});
  
  if (!name || !species) {
    alert('Please enter animal name and species.');
    return;
  }
  
  var newAnimal = {
    id: Date.now(),
    name: name,
    species: species,
    intakeDate: intakeDate || new Date().toISOString().split('T')[0],
    intakeNotes: intakeNotes,
    weights: [],
    healthEntries: [],
    photos: [],
    treatments: [],
    feedingLogs: [],
    feedingTimes: []
  };
  
  animals.push(newAnimal);
  console.log('Animal added:', newAnimal);
  
  saveData();
  
  // Clear form
  document.getElementById('animalName').value = '';
  document.getElementById('intakeDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('intakeNotes').value = '';
  
  renderAnimals();
  updateSelects();
  alert(name + ' has been added successfully!');
  
  showTab('home');
}

function addAnimal() {
  console.log('addAnimal function called');
  
  var name = document.getElementById('animalName').value.trim();
  var species = document.getElementById('animalSpecies').value;
  var intakeDate = document.getElementById('intakeDate').value;
  var intakeNotes = document.getElementById('intakeNotes').value.trim();
  
  console.log('Form values:', {name: name, species: species, intakeDate: intakeDate});
  
  if (!name || !species) {
    alert('Please enter animal name and species.');
    return;
  }
  
  var newAnimal = {
    id: Date.now(),
    name: name,
    species: species,
    intakeDate: intakeDate || new Date().toISOString().split('T')[0],
    intakeNotes: intakeNotes,
    weights: [],
    healthEntries: [],
    photos: [],
    treatments: [],
    feedingLogs: [],
    feedingTimes: []
  };
  
  animals.push(newAnimal);
  console.log('Animal added:', newAnimal);
  
  saveData();
  
  // Clear form
  document.getElementById('animalName').value = '';
  document.getElementById('intakeDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('intakeNotes').value = '';
  
  renderAnimals();
  updateSelects();
  alert(name + ' has been added successfully!');
  
  showTab('home');
}

function renderAnimals() {
  var list = document.getElementById('animalList');
  var counter = document.getElementById('animalCounter');

  var searchQuery = document.getElementById('animalSearch') ? document.getElementById('animalSearch').value.trim().toLowerCase() : '';
  var speciesFilter = document.getElementById('speciesFilter') ? document.getElementById('speciesFilter').value : '';

  list.innerHTML = '';
  counter.textContent = '';

  if (animals.length === 0) {
    list.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No animals added yet. Add your first animal using the "Add New Animal" tab!</p>';
    return;
  }

  var filteredAnimals = animals.filter(function(animal) {
    var matchesSearch = !searchQuery ||
      (animal.name && animal.name.toLowerCase().includes(searchQuery)) ||
      (animal.species && animal.species.toLowerCase().includes(searchQuery)) ||
      (animal.intakeNotes && animal.intakeNotes.toLowerCase().includes(searchQuery));
    
    var matchesSpecies = !speciesFilter || animal.species === speciesFilter;
    
    return matchesSearch && matchesSpecies;
  });

  counter.textContent = 'Showing ' + filteredAnimals.length + ' of ' + animals.length + ' animals';

  if (filteredAnimals.length === 0) {
    list.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No matches found. Try adjusting your search or filter.</p>';
    return;
  }

  filteredAnimals.forEach(function(animal) {
    var div = document.createElement('div');
    div.className = 'animal-item';
    div.onclick = function() { showAnimalDetail(animal.id); };
    
    var daysSinceIntake = animal.intakeDate ? 
      Math.floor((new Date() - new Date(animal.intakeDate)) / (1000 * 60 * 60 * 24)) : 
      'Unknown';
    
    var latestWeight = '';
    if (animal.weights && animal.weights.length > 0) {
      var sorted = animal.weights.slice().sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
      latestWeight = ' • Latest: ' + sorted[0].weight + 'g';
    }
    
    div.innerHTML = 
      '<div class="animal-actions">' +
      '<button class="small" onclick="event.stopPropagation(); deleteAnimal(' + animal.id + ')" style="background: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6;">🗑️</button>' +
      '</div>' +
      '<h4>' + animal.name + '</h4>' +
      '<p><strong>Species:</strong> ' + animal.species + '</p>' +
      '<p><strong>Intake:</strong> ' + formatDate(animal.intakeDate) + ' (' + daysSinceIntake + ' days ago)</p>' +
      '<p><strong>Records:</strong> ' + (animal.weights ? animal.weights.length : 0) + ' weights, ' + (animal.healthEntries ? animal.healthEntries.length : 0) + ' health entries' + latestWeight + '</p>' +
      (animal.intakeNotes ? '<p><strong>Notes:</strong> ' + (animal.intakeNotes.length > 100 ? animal.intakeNotes.substring(0, 100) + '...' : animal.intakeNotes) + '</p>' : '') +
      '<div style="margin-top: 10px; padding: 8px; background: #e7f5e4; border-radius: 5px; font-size: 12px; color: #657a6b; text-align: center;">Click to view full record</div>';
    
    list.appendChild(div);
  });
}

function deleteAnimal(id) {
  var animal = animals.find(function(a) { return a.id == id; });
  if (!animal) return;
  
  if (!confirm('Delete ' + animal.name + '? This cannot be undone.')) return;
  
  animals = animals.filter(function(a) { return a.id != id; });
  saveData();
  renderAnimals();
  updateSelects();
  
  var detailTab = document.getElementById('animalDetailTab');
  if (detailTab && detailTab.classList.contains('active')) {
    showTab('home');
  }
}

function showAnimalDetail(animalId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal) return;
  
  document.querySelectorAll('.nav-tab').forEach(function(tab) { 
    tab.classList.remove('active'); 
  });
  document.querySelectorAll('.tab-content').forEach(function(content) { 
    content.classList.remove('active'); 
  });
  document.getElementById('animalDetailTab').classList.add('active');
  
  var content = document.getElementById('animalDetailContent');
  content.innerHTML = 
    '<div class="card">' +
    '<h2>' + animal.name + '</h2>' +
    '<p><strong>Species:</strong> ' + animal.species + '</p>' +
    '<p><strong>Intake:</strong> ' + formatDate(animal.intakeDate) + ' (' + Math.floor((new Date() - new Date(animal.intakeDate)) / (1000 * 60 * 60 * 24)) + ' days ago)</p>' +
    (animal.intakeNotes ? '<p><strong>Intake Notes:</strong> ' + animal.intakeNotes + '</p>' : '') +
    '</div>' +
    '<div class="card">' +
    '<h3>Care Sections</h3>' +
    '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">' +
    '<button onclick="showAnimalSection(' + animal.id + ', \'weight\')" style="text-align: left; padding: 15px;">⚖️ Weight & Feeding</button>' +
    '<button onclick="showAnimalSection(' + animal.id + ', \'health\')" style="text-align: left; padding: 15px;">🏥 Health Tracking</button>' +
    '<button onclick="showAnimalSection(' + animal.id + ', \'treatments\')" style="text-align: left; padding: 15px;">💊 Treatments</button>' +
    '<button onclick="showAnimalSection(' + animal.id + ', \'feeding\')" style="text-align: left; padding: 15px;">📅 Daily Feeding</button>' +
    '<button onclick="showAnimalSection(' + animal.id + ', \'schedule\')" style="text-align: left; padding: 15px;">⏰ Feeding Schedule</button>' +
    '<button onclick="showAnimalSection(' + animal.id + ', \'photos\')" style="text-align: left; padding: 15px;">📸 Photo Gallery</button>' +
    '</div>' +
    '</div>' +
    '<div id="animalSectionContent"></div>';
  
  showAnimalSection(animal.id, 'weight');
}

function showAnimalSection(animalId, section) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal) return;
  
  var content = document.getElementById('animalSectionContent');
  content.innerHTML = '';
  
  switch(section) {
    case 'weight':
      showWeightSection(animal, content);
      break;
    case 'health':
      showHealthSection(animal, content);
      break;
    case 'treatments':
      content.innerHTML = '<div class="card"><h3>Treatments</h3><p>Treatment logging features coming soon...</p></div>';
      break;
    case 'feeding':
      content.innerHTML = '<div class="card"><h3>Daily Feeding</h3><p>Daily feeding checklist features coming soon...</p></div>';
      break;
    case 'schedule':
      showScheduleSection(animal, content);
      break;
    case 'photos':
      content.innerHTML = '<div class="card"><h3>Photo Gallery</h3><p>Photo gallery features coming soon...</p></div>';
      break;
  }
}

function showWeightSection(animal, container) {
  var card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = '<h3>Weight Tracking & Feed Calculator</h3>';
  
  var form = document.createElement('div');
  form.innerHTML = 
    '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">' +
    '<div><label>Date: <input type="date" id="weightDate-' + animal.id + '" value="' + new Date().toISOString().split('T')[0] + '"></label></div>' +
    '<div><label>Weight (g): <input type="number" id="animalWeight-' + animal.id + '" placeholder="Enter weight in grams"></label></div>' +
    '<div style="display: flex; align-items: end;"><button onclick="addWeightForAnimal(' + animal.id + ')">Add Weight</button></div>' +
    '</div>';
  card.appendChild(form);
  
  var resultDiv = document.createElement('div');
  resultDiv.id = 'feedResult-' + animal.id;
  resultDiv.className = 'result';
  card.appendChild(resultDiv);
  
  var historyDiv = document.createElement('div');
  historyDiv.id = 'weightHistory-' + animal.id;
  card.appendChild(historyDiv);
  
  container.appendChild(card);
  
  showWeightHistoryForAnimal(animal);
  
  document.getElementById('animalWeight-' + animal.id).oninput = function() {
    showFeedCalcForAnimal(animal);
  };
}

function showScheduleSection(animal, container) {
  var card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = '<h3>Feeding Schedule for ' + animal.name + '</h3>';
  
  // Get current feeding requirements
  var currentWeight = getCurrentWeight(animal);
  var feedsPerDay = currentWeight ? getFeedsPerDay(currentWeight, animal.species) : 0;
  
  // Initialize feeding times if they don't exist
  if (!animal.feedingTimes) {
    animal.feedingTimes = [];
  }
  
  // Generate default schedule if empty and we have weight data
  if (animal.feedingTimes.length === 0 && feedsPerDay > 0) {
    generateDefaultSchedule(animal, feedsPerDay);
  }
  
  // Schedule management section
  var scheduleControls = document.createElement('div');
  scheduleControls.innerHTML = 
    '<div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">' +
    '<h4>Schedule Management</h4>' +
    '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">' +
    '<div><label>Current Weight (g): <input type="number" id="scheduleWeight-' + animal.id + '" value="' + (currentWeight || '') + '" placeholder="Enter current weight"></label></div>' +
    '<div style="display: flex; align-items: end; gap: 10px;">' +
    '<button onclick="updateScheduleForWeight(' + animal.id + ')">Update Schedule</button>' +
    '<button onclick="addCustomFeedingTime(' + animal.id + ')" style="background: #28a745;">Add Custom Time</button>' +
    '</div>' +
    '</div>' +
    '</div>';
  card.appendChild(scheduleControls);
  
  // Summary cards
  var summaryDiv = document.createElement('div');
  summaryDiv.className = 'schedule-summary';
  summaryDiv.id = 'scheduleSummary-' + animal.id;
  card.appendChild(summaryDiv);
  
  // Feeding times grid
  var scheduleDiv = document.createElement('div');
  scheduleDiv.className = 'feeding-schedule-grid';
  scheduleDiv.id = 'feedingSchedule-' + animal.id;
  card.appendChild(scheduleDiv);
  
  container.appendChild(card);
  
  updateScheduleDisplay(animal);
}

function getCurrentWeight(animal) {
  if (!animal.weights || animal.weights.length === 0) return null;
  var sorted = animal.weights.slice().sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
  return sorted[0].weight;
}

function generateDefaultSchedule(animal, feedsPerDay) {
  animal.feedingTimes = [];
  
  // Default feeding times based on number of feeds
  var defaultTimes = {
    1: ['19:00'],
    2: ['07:00', '19:00'],
    3: ['07:00', '15:00', '22:00'],
    4: ['06:00', '12:00', '18:00', '00:00'],
    5: ['06:00', '11:00', '16:00', '21:00', '02:00'],
    6: ['06:00', '10:00', '14:00', '18:00', '22:00', '02:00'],
    8: ['06:00', '09:00', '12:00', '15:00', '18:00', '21:00', '00:00', '03:00']
  };
  
  var times = defaultTimes[feedsPerDay] || defaultTimes[6];
  
  times.forEach(function(time, index) {
    animal.feedingTimes.push({
      id: Date.now() + index,
      time: time,
      description: 'Feed ' + (index + 1),
      enabled: true
    });
  });
  
  saveData();
}

function updateScheduleForWeight(animalId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal) return;
  
  var weightInput = document.getElementById('scheduleWeight-' + animalId);
  var weight = parseFloat(weightInput.value);
  
  if (!weight || weight <= 0) {
    alert('Please enter a valid weight.');
    return;
  }
  
  var feedsPerDay = getFeedsPerDay(weight, animal.species);
  
  if (confirm('This will update the feeding schedule to ' + feedsPerDay + ' feeds per day based on ' + weight + 'g weight. Continue?')) {
    generateDefaultSchedule(animal, feedsPerDay);
    updateScheduleDisplay(animal);
  }
}

function generateTimeOptions() {
  var options = '';
  for (var hour = 0; hour < 24; hour++) {
    for (var minute = 0; minute < 60; minute += 15) {
      var timeStr = String(hour).padStart(2, '0') + ':' + String(minute).padStart(2, '0');
      var displayTime = formatTime(timeStr);
      options += '<option value="' + timeStr + '">' + displayTime + '</option>';
    }
  }
  return options;
}

function addCustomFeedingTime(animalId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal) return;
  
  var modalHtml = 
    '<div id="feedingTimeModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">' +
    '<div style="background: white; padding: 30px; border-radius: 15px; max-width: 400px; width: 90%;">' +
    '<h3 style="margin-top: 0;">Add Feeding Time</h3>' +
    '<label>Time: <select id="newFeedingTime" style="margin-top: 10px;">' + generateTimeOptions() + '</select></label>' +
    '<label>Description: <input type="text" id="newFeedingDescription" value="Custom feed" style="margin-top: 15px;"></label>' +
    '<div style="margin-top: 20px; text-align: right;">' +
    '<button onclick="closeFeedingTimeModal()" style="background: #6c757d; margin-right: 10px;">Cancel</button>' +
    '<button onclick="saveFeedingTime(' + animalId + ')">Add Time</button>' +
    '</div>' +
    '</div>' +
    '</div>';
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeFeedingTimeModal() {
  var modal = document.getElementById('feedingTimeModal');
  if (modal) {
    modal.remove();
  }
}

function saveFeedingTime(animalId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal) return;
  
  var time = document.getElementById('newFeedingTime').value;
  var description = document.getElementById('newFeedingDescription').value.trim() || 'Custom feed';
  
  if (!animal.feedingTimes) animal.feedingTimes = [];
  
  animal.feedingTimes.push({
    id: Date.now(),
    time: time,
    description: description,
    enabled: true
  });
  
  // Sort by time
  animal.feedingTimes.sort(function(a, b) {
    return a.time.localeCompare(b.time);
  });
  
  saveData();
  updateScheduleDisplay(animal);
  closeFeedingTimeModal();
}

function updateScheduleDisplay(animal) {
  var summaryDiv = document.getElementById('scheduleSummary-' + animal.id);
  var scheduleDiv = document.getElementById('feedingSchedule-' + animal.id);
  
  if (!summaryDiv || !scheduleDiv) return;
  
  // Calculate summary stats
  var totalFeeds = animal.feedingTimes ? animal.feedingTimes.filter(function(ft) { return ft.enabled; }).length : 0;
  var todayFeeds = getTodayFeedingLogs(animal).length;
  var completedFeeds = getTodayCompletedFeeds(animal);
  var overdueFeeds = getTodayOverdueFeeds(animal);
  
  // Update summary
  summaryDiv.innerHTML = 
    '<div class="summary-card">' +
    '<div class="summary-number">' + totalFeeds + '</div>' +
    '<div class="summary-label">Daily Feeds</div>' +
    '</div>' +
    '<div class="summary-card">' +
    '<div class="summary-number">' + completedFeeds + '</div>' +
    '<div class="summary-label">Completed Today</div>' +
    '</div>' +
    '<div class="summary-card">' +
    '<div class="summary-number">' + overdueFeeds + '</div>' +
    '<div class="summary-label">Overdue</div>' +
    '</div>' +
    '<div class="summary-card">' +
    '<div class="summary-number">' + (totalFeeds - completedFeeds) + '</div>' +
    '<div class="summary-label">Remaining</div>' +
    '</div>';
  
  // Update schedule
  scheduleDiv.innerHTML = '';
  
  if (!animal.feedingTimes || animal.feedingTimes.length === 0) {
    scheduleDiv.innerHTML = '<p style="text-align: center; color: #666; font-style: italic; grid-column: 1/-1;">No feeding schedule set. Enter a current weight to generate a schedule.</p>';
    return;
  }
  
  animal.feedingTimes.forEach(function(feedTime) {
    if (!feedTime.enabled) return;
    
    var status = getFeedingStatus(animal, feedTime);
    var card = document.createElement('div');
    card.className = 'feeding-time-card ' + status.class;
    
    // Get today's feeding log for this time to show notes
    var todayLog = getTodayFeedingLogForTime(animal, feedTime.time);
    var hasNotes = todayLog && todayLog.notes && todayLog.notes.trim();
    var notesIcon = hasNotes ? '📝' : '📝';
    var notesColor = hasNotes ? '#28a745' : '#6c757d';
    
    card.innerHTML = 
      '<div class="feeding-time-header">' +
      '<div class="feeding-time-main">' +
      '<div class="feeding-time-info">' +
      '<select class="feeding-time-select" id="feedingTimeSelect-' + feedTime.id + '" onchange="updateFeedingTime(' + animal.id + ', ' + feedTime.id + ', this.value)">' +
      generateTimeOptionsWithSelected(feedTime.time) +
      '</select>' +
      '<input type="text" class="feeding-description" id="feedingDesc-' + feedTime.id + '" value="' + feedTime.description + '" onchange="updateFeedingDescription(' + animal.id + ', ' + feedTime.id + ', this.value)" placeholder="Enter description">' +
      '</div>' +
      '<div class="feeding-time-controls">' +
      '<span class="status-badge status-' + status.class + '">' + status.text + '</span>' +
      '<button class="notes-button" onclick="showFeedingNotes(' + animal.id + ', \'' + feedTime.time + '\')" style="color: ' + notesColor + '; border-color: ' + notesColor + ';" title="' + (hasNotes ? 'View/Edit Notes' : 'Add Notes') + '">' + notesIcon + '</button>' +
      '</div>' +
      '</div>' +
      '</div>' +
      (hasNotes ? '<div class="notes-preview"><strong>Notes:</strong> ' + (todayLog.notes.length > 60 ? todayLog.notes.substring(0, 60) + '...' : todayLog.notes) + '</div>' : '') +
      '<div class="feeding-actions">' +
      (status.class === 'completed' ? 
        '<button onclick="unmarkFeedingComplete(' + animal.id + ', \'' + feedTime.time + '\')" style="background: #6c757d;">Undo</button>' :
        '<button onclick="markFeedingComplete(' + animal.id + ', \'' + feedTime.time + '\')">Complete</button>'
      ) +
      '<button onclick="deleteFeedingTime(' + animal.id + ', ' + feedTime.id + ')" style="background: #dc3545;">Delete</button>' +
      '</div>';
    
    scheduleDiv.appendChild(card);
  });
}

function getTodayFeedingLogForTime(animal, scheduledTime) {
  if (!animal.feedingLogs) return null;
  var today = new Date().toISOString().split('T')[0];
  return animal.feedingLogs.find(function(log) {
    return log.date === today && log.scheduledTime === scheduledTime;
  });
}

function showFeedingNotes(animalId, scheduledTime) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal) return;
  
  var today = new Date().toISOString().split('T')[0];
  var todayLog = getTodayFeedingLogForTime(animal, scheduledTime);
  var currentNotes = todayLog ? (todayLog.notes || '') : '';
  var isCompleted = todayLog ? true : false;
  
  var modalHtml = 
    '<div id="feedingNotesModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">' +
    '<div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">' +
    '<h3 style="margin-top: 0;">Feeding Notes - ' + formatTime(scheduledTime) + '</h3>' +
    '<p style="color: #666; margin-bottom: 20px;">Date: ' + formatDate(today) + '</p>' +
    (isCompleted ? 
      '<div style="margin-bottom: 15px; padding: 10px; background: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; color: #155724;"><strong>✓ Feeding completed</strong> at ' + (todayLog.actualTime ? formatTime(todayLog.actualTime) : 'unknown time') + '</div>' :
      '<div style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; color: #856404;"><strong>⏳ Feeding not completed yet</strong></div>'
    ) +
    '<label style="display: block; margin-bottom: 10px; font-weight: 600;">Notes:</label>' +
    '<textarea id="feedingNotesText" placeholder="Record any feeding observations, issues, amounts consumed, behavior, etc..." style="width: 100%; height: 120px; padding: 12px; border: 2px solid #e1e8ed; border-radius: 8px; font-family: inherit; resize: vertical;">' + currentNotes + '</textarea>' +
    '<div style="margin-top: 20px; text-align: right;">' +
    '<button onclick="closeFeedingNotesModal()" style="background: #6c757d; margin-right: 10px;">Cancel</button>' +
    '<button onclick="saveFeedingNotes(' + animalId + ', \'' + scheduledTime + '\')">Save Notes</button>' +
    '</div>' +
    '</div>' +
    '</div>';
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  
  // Focus on the textarea
  setTimeout(function() {
    var textarea = document.getElementById('feedingNotesText');
    if (textarea) {
      textarea.focus();
    }
  }, 100);
}

function closeFeedingNotesModal() {
  var modal = document.getElementById('feedingNotesModal');
  if (modal) {
    modal.remove();
  }
}

function saveFeedingNotes(animalId, scheduledTime) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal) return;
  
  var notes = document.getElementById('feedingNotesText').value.trim();
  var today = new Date().toISOString().split('T')[0];
  
  if (!animal.feedingLogs) animal.feedingLogs = [];
  
  // Find existing log for today and this time
  var existingLog = animal.feedingLogs.find(function(log) {
    return log.date === today && log.scheduledTime === scheduledTime;
  });
  
  if (existingLog) {
    // Update existing log with notes
    existingLog.notes = notes;
  } else {
    // Create new log entry just for notes (not marked as completed)
    animal.feedingLogs.push({
      id: Date.now(),
      date: today,
      scheduledTime: scheduledTime,
      notes: notes,
      notesOnly: true // Flag to indicate this is just notes, not a completed feeding
    });
  }
  
  saveData();
  updateScheduleDisplay(animal);
  closeFeedingNotesModal();
}

function markFeedingComplete(animalId, scheduledTime) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal) return;
  
  if (!animal.feedingLogs) animal.feedingLogs = [];
  
  var today = new Date().toISOString().split('T')[0];
  var now = new Date();
  
  // Check if already completed
  var existingLog = animal.feedingLogs.find(function(log) {
    return log.date === today && log.scheduledTime === scheduledTime && !log.notesOnly;
  });
  
  if (existingLog) {
    alert('This feeding has already been marked as complete.');
    return;
  }
  
  // Check if there's a notes-only entry
  var notesOnlyLog = animal.feedingLogs.find(function(log) {
    return log.date === today && log.scheduledTime === scheduledTime && log.notesOnly;
  });
  
  if (notesOnlyLog) {
    // Convert notes-only entry to completed feeding
    notesOnlyLog.actualTime = now.toTimeString().substr(0, 5);
    notesOnlyLog.completedAt = now.toISOString();
    delete notesOnlyLog.notesOnly;
  } else {
    // Create new completed feeding log
    animal.feedingLogs.push({
      id: Date.now(),
      date: today,
      actualTime: now.toTimeString().substr(0, 5),
      scheduledTime: scheduledTime,
      completedAt: now.toISOString()
    });
  }
  
  saveData();
  updateScheduleDisplay(animal);
}

function getTodayFeedingLogs(animal) {
  if (!animal.feedingLogs) return [];
  var today = new Date().toISOString().split('T')[0];
  return animal.feedingLogs.filter(function(log) {
    return log.date === today;
  });
}function(a) { return a.id == animalId; });
  if (!animal) return;
  
  var date = document.getElementById('healthEntryDate').value;
  var time = document.getElementById('healthEntryTime').value;
  var type = document.getElementById('healthEntryType').value;
  var notes = document.getElementById('healthEntryNotes').value.trim();
  
  if (!date || !type) {
    alert('Please fill in date and type.');
    return;
  }
  
  if (!notes) {
    alert('Please enter some notes for this health entry.');
    return;
  }
  
  var healthEntry = {
    id: Date.now(),
    date: date,
    time: time,
    type: type,
    notes: notes
  };
  
  if (!animal.healthEntries) animal.healthEntries = [];
  animal.healthEntries.push(healthEntry);
  
  saveData();
  updateHealthDisplay(animal);
  closeHealthEntryModal();
}

function editHealthEntry(animalId, entryId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal || !animal.healthEntries) return;
  
  var entry = animal.healthEntries.find(function(e) { return e.id === entryId; });
  if (!entry) return;
  
  var modalHtml = 
    '<div id="healthEntryModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">' +
    '<div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">' +
    '<h3 style="margin-top: 0;">Edit Health Entry</h3>' +
    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">' +
    '<div><label>Date: <input type="date" id="healthEntryDate" value="' + entry.date + '"></label></div>' +
    '<div><label>Time: <select id="healthEntryTime">' + generateTimeOptionsWithSelected(entry.time || '12:00') + '</select></label></div>' +
    '</div>' +
    '<label>Type: <select id="healthEntryType" style="margin-top: 10px;">' +
    '<option value="observation"' + (entry.type === 'observation' ? ' selected' : '') + '>Daily Observation</option>' +
    '<option value="concern"' + (entry.type === 'concern' ? ' selected' : '') + '>Health Concern</option>' +
    '<option value="improvement"' + (entry.type === 'improvement' ? ' selected' : '') + '>Improvement</option>' +
    '<option value="medication"' + (entry.type === 'medication' ? ' selected' : '') + '>Medication Given</option>' +
    '<option value="vet-visit"' + (entry.type === 'vet-visit' ? ' selected' : '') + '>Vet Visit</option>' +
    '</select></label>' +
    '<label>Notes: <textarea id="healthEntryNotes" placeholder="Enter detailed health notes..." style="margin-top: 15px; height: 120px;">' + (entry.notes || '') + '</textarea></label>' +
    '<div style="margin-top: 20px; text-align: right;">' +
    '<button onclick="closeHealthEntryModal()" style="background: #6c757d; margin-right: 10px;">Cancel</button>' +
    '<button onclick="updateHealthEntry(' + animalId + ', ' + entryId + ')">Update Entry</button>' +
    '</div>' +
    '</div>' +
    '</div>';
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function updateHealthEntry(animalId, entryId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal || !animal.healthEntries) return;
  
  var entry = animal.healthEntries.find(function(e) { return e.id === entryId; });
  if (!entry) return;
  
  var date = document.getElementById('healthEntryDate').value;
  var time = document.getElementById('healthEntryTime').value;
  var type = document.getElementById('healthEntryType').value;
  var notes = document.getElementById('healthEntryNotes').value.trim();
  
  if (!date || !type) {
    alert('Please fill in date and type.');
    return;
  }
  
  if (!notes) {
    alert('Please enter some notes for this health entry.');
    return;
  }
  
  entry.date = date;
  entry.time = time;
  entry.type = type;
  entry.notes = notes;
  
  saveData();
  updateHealthDisplay(animal);
  closeHealthEntryModal();
}

function deleteHealthEntry(animalId, entryId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal || !animal.healthEntries) return;
  
  if (!confirm('Delete this health entry? This cannot be undone.')) return;
  
  animal.healthEntries = animal.healthEntries.filter(function(e) {
    return e.id !== entryId;
  });
  
  saveData();
  updateHealthDisplay(animal);
}

function generateTimeOptionsWithSelected(selectedTime) {
  var options = '';
  for (var hour = 0; hour < 24; hour++) {
    for (var minute = 0; minute < 60; minute += 15) {
      var timeStr = String(hour).padStart(2, '0') + ':' + String(minute).padStart(2, '0');
      var displayTime = formatTime(timeStr);
      var selected = timeStr === selectedTime ? ' selected' : '';
      options += '<option value="' + timeStr + '"' + selected + '>' + displayTime + '</option>';
    }
  }
  return options;
}

function updateFeedingTime(animalId, feedingTimeId, newTime) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal || !animal.feedingTimes) return;
  
  var feedingTime = animal.feedingTimes.find(function(ft) { return ft.id === feedingTimeId; });
  if (!feedingTime) return;
  
  feedingTime.time = newTime;
  
  // Sort by time after update
  animal.feedingTimes.sort(function(a, b) {
    return a.time.localeCompare(b.time);
  });
  
  saveData();
  updateScheduleDisplay(animal);
}

function updateFeedingDescription(animalId, feedingTimeId, newDescription) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal || !animal.feedingTimes) return;
  
  var feedingTime = animal.feedingTimes.find(function(ft) { return ft.id === feedingTimeId; });
  if (!feedingTime) return;
  
  feedingTime.description = newDescription.trim() || 'Feed';
  saveData();
}

function showHealthSection(animal, container) {
  var card = document.createElement('div');
  card.className = 'card';
  card.innerHTML = '<h3>Health Tracking for ' + animal.name + '</h3>';
  
  // Initialize health entries if they don't exist
  if (!animal.healthEntries) {
    animal.healthEntries = [];
  }
  
  // Health summary
  var summaryDiv = document.createElement('div');
  summaryDiv.className = 'health-summary-grid';
  summaryDiv.id = 'healthSummary-' + animal.id;
  card.appendChild(summaryDiv);
  
  // Quick action buttons
  var quickActionsDiv = document.createElement('div');
  quickActionsDiv.className = 'health-quick-actions';
  quickActionsDiv.innerHTML = 
    '<button class="quick-action-btn" onclick="addQuickHealthEntry(' + animal.id + ', \'observation\')">' +
    '<div style="font-size: 16px; margin-bottom: 4px;">👁️</div>' +
    'Daily Observation' +
    '</button>' +
    '<button class="quick-action-btn" onclick="addQuickHealthEntry(' + animal.id + ', \'concern\')">' +
    '<div style="font-size: 16px; margin-bottom: 4px;">⚠️</div>' +
    'Health Concern' +
    '</button>' +
    '<button class="quick-action-btn" onclick="addQuickHealthEntry(' + animal.id + ', \'improvement\')">' +
    '<div style="font-size: 16px; margin-bottom: 4px;">✅</div>' +
    'Improvement' +
    '</button>' +
    '<button class="quick-action-btn" onclick="addQuickHealthEntry(' + animal.id + ', \'medication\')">' +
    '<div style="font-size: 16px; margin-bottom: 4px;">💊</div>' +
    'Medication Given' +
    '</button>' +
    '<button class="quick-action-btn" onclick="addQuickHealthEntry(' + animal.id + ', \'vet-visit\')">' +
    '<div style="font-size: 16px; margin-bottom: 4px;">🏥</div>' +
    'Vet Visit' +
    '</button>' +
    '<button class="quick-action-btn" onclick="showAddHealthEntryModal(' + animal.id + ')">' +
    '<div style="font-size: 16px; margin-bottom: 4px;">➕</div>' +
    'Custom Entry' +
    '</button>';
  card.appendChild(quickActionsDiv);
  
  // Health entries list
  var entriesDiv = document.createElement('div');
  entriesDiv.id = 'healthEntries-' + animal.id;
  card.appendChild(entriesDiv);
  
  container.appendChild(card);
  
  updateHealthDisplay(animal);
}

function getFeedingStatus(animal, feedTime) {
  var today = new Date().toISOString().split('T')[0];
  var now = new Date();
  var feedDateTime = new Date(today + 'T' + feedTime.time + ':00');
  
  // Check if already completed today
  var todayLogs = getTodayFeedingLogs(animal);
  var isCompleted = todayLogs.some(function(log) {
    return log.scheduledTime === feedTime.time;
  });
  
  if (isCompleted) {
    return { class: 'completed', text: 'Done' };
  }
  
  // Check if overdue (more than 30 minutes past scheduled time)
  var overdueTime = new Date(feedDateTime.getTime() + 30 * 60 * 1000);
  if (now > overdueTime) {
    return { class: 'overdue', text: 'Overdue' };
  }
  
  // Check if upcoming (within 1 hour of scheduled time)
  var upcomingTime = new Date(feedDateTime.getTime() - 60 * 60 * 1000);
  if (now >= upcomingTime && now <= feedDateTime) {
    return { class: 'upcoming', text: 'Soon' };
  }
  
  return { class: 'pending', text: 'Pending' };
}

function getTodayFeedingLogs(animal) {
  if (!animal.feedingLogs) return [];
  var today = new Date().toISOString().split('T')[0];
  return animal.feedingLogs.filter(function(log) {
    return log.date === today;
  });
}

function getTodayCompletedFeeds(animal) {
  if (!animal.feedingLogs) return 0;
  var today = new Date().toISOString().split('T')[0];
  return animal.feedingLogs.filter(function(log) {
    return log.date === today && !log.notesOnly;
  }).length;
}

function unmarkFeedingComplete(animalId, scheduledTime) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal || !animal.feedingLogs) return;
  
  var today = new Date().toISOString().split('T')[0];
  
  // Find the completed feeding log
  var completedLog = animal.feedingLogs.find(function(log) {
    return log.date === today && log.scheduledTime === scheduledTime && !log.notesOnly;
  });
  
  if (completedLog) {
    if (completedLog.notes && completedLog.notes.trim()) {
      // If there are notes, convert back to notes-only entry
      completedLog.notesOnly = true;
      delete completedLog.actualTime;
      delete completedLog.completedAt;
    } else {
      // If no notes, remove the log entirely
      animal.feedingLogs = animal.feedingLogs.filter(function(log) {
        return log !== completedLog;
      });
    }
  }
  
  saveData();
  updateScheduleDisplay(animal);
}

function getTodayOverdueFeeds(animal) {
  if (!animal.feedingTimes) return 0;
  var now = new Date();
  var today = new Date().toISOString().split('T')[0];
  var todayLogs = getTodayFeedingLogs(animal);
  
  return animal.feedingTimes.filter(function(feedTime) {
    if (!feedTime.enabled) return false;
    
    var feedDateTime = new Date(today + 'T' + feedTime.time + ':00');
    var overdueTime = new Date(feedDateTime.getTime() + 30 * 60 * 1000);
    
    var isCompleted = todayLogs.some(function(log) {
      return log.scheduledTime === feedTime.time;
    });
    
    return !isCompleted && now > overdueTime;
  }).length;
}

function markFeedingComplete(animalId, scheduledTime) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal) return;
  
  if (!animal.feedingLogs) animal.feedingLogs = [];
  
  var today = new Date().toISOString().split('T')[0];
  var now = new Date();
  
  // Check if already completed
  var existingLog = animal.feedingLogs.find(function(log) {
    return log.date === today && log.scheduledTime === scheduledTime;
  });
  
  if (existingLog) {
    alert('This feeding has already been marked as complete.');
    return;
  }
  
  animal.feedingLogs.push({
    id: Date.now(),
    date: today,
    actualTime: now.toTimeString().substr(0, 5),
    scheduledTime: scheduledTime,
    completedAt: now.toISOString()
  });
  
  saveData();
  updateScheduleDisplay(animal);
}

function unmarkFeedingComplete(animalId, scheduledTime) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal || !animal.feedingLogs) return;
  
  var today = new Date().toISOString().split('T')[0];
  
  animal.feedingLogs = animal.feedingLogs.filter(function(log) {
    return !(log.date === today && log.scheduledTime === scheduledTime);
  });
  
  saveData();
  updateScheduleDisplay(animal);
}

function deleteFeedingTime(animalId, feedingTimeId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal || !animal.feedingTimes) return;
  
  if (!confirm('Delete this feeding time?')) return;
  
  animal.feedingTimes = animal.feedingTimes.filter(function(ft) {
    return ft.id !== feedingTimeId;
  });
  
  saveData();
  updateScheduleDisplay(animal);
}

function addWeightForAnimal(animalId) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal) return;
  
  var date = document.getElementById('weightDate-' + animalId).value;
  var weight = parseFloat(document.getElementById('animalWeight-' + animalId).value);
  
  if (!date || !weight || weight <= 0) {
    alert('Please enter a valid date and weight.');
    return;
  }
  
  if (!animal.weights) animal.weights = [];
  animal.weights.push({ date: date, weight: weight });
  
  saveData();
  showWeightHistoryForAnimal(animal);
  
  document.getElementById('weightDate-' + animalId).value = new Date().toISOString().split('T')[0];
  document.getElementById('animalWeight-' + animalId).value = '';
  
  alert('Weight added successfully!');
}

function showFeedCalcForAnimal(animal) {
  var weightInput = document.getElementById('animalWeight-' + animal.id);
  if (!weightInput) return;
  
  var weight = parseFloat(weightInput.value);
  
  if (!weight || weight <= 0) {
    var resultDiv = document.getElementById('feedResult-' + animal.id);
    if (resultDiv) resultDiv.innerHTML = '';
    return;
  }
  
  var species = animal.species;
  var feeds = getFeedsPerDay(weight, species);
  var dailyMilk = weight * 0.15;
  var perFeed = dailyMilk / feeds;
  var info = getAnimalInfo(weight, species);
  
  var resultDiv = document.getElementById('feedResult-' + animal.id);
  if (resultDiv) {
    resultDiv.innerHTML = 
      '<strong>Feed Calculation for ' + species + ' - ' + weight + 'g:</strong><br>' +
      'Feeds per day: ' + feeds + '<br>' +
      'Daily milk: ' + dailyMilk.toFixed(1) + ' g<br>' +
      'Milk per feed: ' + perFeed.toFixed(1) + ' g<br><br>' +
      '<strong>Care Information:</strong><br>' +
      '<strong>Predicted Age:</strong> ' + info.predictedAge + '<br>' +
      '<strong>Features/Behaviour:</strong> ' + info.features + '<br>' +
      '<strong>Housing:</strong> ' + info.housing + '<br>' +
      '<strong>Feeding Notes:</strong> ' + info.feedingNotes + '<br>' +
      '<strong>Milk Formula:</strong> ' + info.milkFormula;
  }
}

function showWeightHistoryForAnimal(animal) {
  var history = document.getElementById('weightHistory-' + animal.id);
  if (!history) return;
  
  history.innerHTML = '<h4>Weight History for ' + animal.name + '</h4>';
  
  if (!animal.weights || animal.weights.length === 0) {
    history.innerHTML += '<p style="color: #666; font-style: italic;">No weight records yet.</p>';
    return;
  }
  
  var sorted = animal.weights.slice().sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
  var mostRecent = sorted[0];
  
  if (mostRecent) {
    var species = animal.species;
    var feeds = getFeedsPerDay(mostRecent.weight, species);
    var dailyMilk = mostRecent.weight * 0.15;
    var perFeed = dailyMilk / feeds;
    var info = getAnimalInfo(mostRecent.weight, species);
    
    var currentWeightInput = document.getElementById('animalWeight-' + animal.id);
    if (!currentWeightInput || !currentWeightInput.value || parseFloat(currentWeightInput.value) <= 0) {
      var resultDiv = document.getElementById('feedResult-' + animal.id);
      if (resultDiv) {
        resultDiv.innerHTML = 
          '<strong>Current Feed Calculation for ' + species + ' - ' + mostRecent.weight + 'g:</strong><br>' +
          '<em>Based on most recent weight (' + formatDate(mostRecent.date) + ')</em><br><br>' +
          'Feeds per day: ' + feeds + '<br>' +
          'Daily milk: ' + dailyMilk.toFixed(1) + ' g<br>' +
          'Milk per feed: ' + perFeed.toFixed(1) + ' g<br><br>' +
          '<strong>Care Information:</strong><br>' +
          '<strong>Predicted Age:</strong> ' + info.predictedAge + '<br>' +
          '<strong>Features/Behaviour:</strong> ' + info.features + '<br>' +
          '<strong>Housing:</strong> ' + info.housing + '<br>' +
          '<strong>Feeding Notes:</strong> ' + info.feedingNotes + '<br>' +
          '<strong>Milk Formula:</strong> ' + info.milkFormula;
      }
    }
  }
  
  history.innerHTML += '<div style="margin-top: 15px;"><strong>Weight Records:</strong></div>';
  
  sorted.forEach(function(w, index) {
    var div = document.createElement('div');
    div.style.cssText = 'padding: 10px; margin: 5px 0; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;';
    
    var weightChange = '';
    if (index < sorted.length - 1) {
      var prevWeight = sorted[index + 1].weight;
      var change = w.weight - prevWeight;
      if (change > 0) {
        weightChange = ' <span style="color: #28a745;">(+' + change.toFixed(0) + 'g)</span>';
      } else if (change < 0) {
        weightChange = ' <span style="color: #dc3545;">(' + change.toFixed(0) + 'g)</span>';
      }
    }
    
    div.innerHTML = 
      '<div>' +
      '<strong>' + formatDate(w.date) + '</strong><br>' +
      w.weight + 'g' + weightChange +
      '</div>' +
      '<div style="display: flex; gap: 5px;">' +
      '<button class="small" onclick="deleteWeightForAnimal(' + animal.id + ', \'' + w.date + '\', ' + w.weight + ')" style="background: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6;">🗑️</button>' +
      '</div>';
    
    history.appendChild(div);
  });
}

function deleteWeightForAnimal(animalId, date, weight) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal || !animal.weights) return;
  
  if (!confirm('Delete weight record: ' + weight + 'g on ' + formatDate(date) + '?')) return;
  
  animal.weights = animal.weights.filter(function(w) { 
    return !(w.date === date && w.weight === weight); 
  });
  
  saveData();
  showWeightHistoryForAnimal(animal);
}

function exportAnimalData() {
  var animalId = document.getElementById('exportAnimalSelect').value;
  var animal = animals.find(function(a) { return a.id == animalId; });
  
  if (!animal) {
    alert('Please select an animal to export.');
    return;
  }
  
  var exportData = {
    animal: animal,
    exportDate: new Date().toISOString(),
    appVersion: 'BushBuddy v2.0'
  };
  
  var dataStr = JSON.stringify(exportData, null, 2);
  var dataBlob = new Blob([dataStr], {type: 'application/json'});
  
  var link = document.createElement('a');
  link.href = URL.createObjectURL(dataBlob);
  link.download = animal.name.replace(/[^a-z0-9]/gi, '_') + '_care_data.json';
  link.click();
}

function exportAllData() {
  if (animals.length === 0) {
    alert('No data to export.');
    return;
  }
  
  var exportData = {
    animals: animals,
    exportDate: new Date().toISOString(),
    appVersion: 'BushBuddy v2.0'
  };
  
  var dataStr = JSON.stringify(exportData, null, 2);
  var dataBlob = new Blob([dataStr], {type: 'application/json'});
  
  var link = document.createElement('a');
  link.href = URL.createObjectURL(dataBlob);
  link.download = 'bushbuddy_backup_' + new Date().toISOString().split('T')[0] + '.json';
  link.click();
}

function restoreData() {
  var fileInput = document.getElementById('restoreInput');
  var file = fileInput.files[0];
  
  if (!file) {
    alert('Please select a backup file to restore.');
    return;
  }
  
  if (!confirm('Restore data from backup? This will replace all current data.')) {
    return;
  }
  
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var importData = JSON.parse(e.target.result);
      
      if (importData.animals) {
        animals = importData.animals;
      } else if (importData.animal) {
        var existingIndex = animals.findIndex(function(a) { return a.id === importData.animal.id; });
        if (existingIndex >= 0) {
          animals[existingIndex] = importData.animal;
        } else {
          animals.push(importData.animal);
        }
      } else {
        throw new Error('Invalid backup file format');
      }
      
      saveData();
      renderAnimals();
      updateSelects();
      alert('Data restored successfully!');
      
    } catch (error) {
      console.error('Error importing data:', error);
      alert('Error reading backup file. Please check the file format.');
    }
  };
  
  reader.readAsText(file);
  fileInput.value = '';
}

function initApp() {
  loadData();
  setDefaultDates();
  updateSelects();
  renderAnimals();
  
  var searchInput = document.getElementById('animalSearch');
  var speciesFilter = document.getElementById('speciesFilter');
  
  if (searchInput) {
    searchInput.addEventListener('input', renderAnimals);
  }
  
  if (speciesFilter) {
    speciesFilter.addEventListener('change', renderAnimals);
  }
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initApp);
} else {
  initApp();
}
</script>

</body>
</html>
