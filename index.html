<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Wildlife Feed Tracker</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2b7a78" />
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
.card { max-width: 500px; padding: 20px; border: 1px solid #ccc; border-radius: 12px; box-shadow: 2px 2px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
label { display: block; margin-top: 12px; }
input, select { width: 100%; padding: 8px; margin-top: 4px; border-radius: 6px; border: 1px solid #aaa; }
button { margin-top: 16px; padding: 10px 15px; border: none; border-radius: 6px; background: #2b7a78; color: white; cursor: pointer; }
button:hover { background: #20504f; }
.result { margin-top: 12px; padding: 12px; border-radius: 8px; background: #f9f9f9; border: 1px solid #eee; }
.modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content:center; align-items:center; }
.modal-content { background:white; padding:20px; border-radius:12px; max-width:300px; width:100%; }
.modal-content h3 { margin-top:0; }
.modal-content label { margin-top:8px; }
.modal-buttons { margin-top:12px; text-align:right; }
.modal-buttons button { margin-left:8px; }
</style>
<script src="./chart.umd.min.js"></script>
</head>
<body>

<div class="card">
  <h2>Animal Management</h2>
  <label>Name: <input type="text" id="animalName"></label>
  <label>Species: <input type="text" id="animalSpecies"></label>
  <button onclick="addAnimal()">Add Animal</button>
  <div id="animalList"></div>
</div>

<div class="card">
  <h2>Weight Tracking & Feed Calculator</h2>
  <label>Select Animal: <select id="animalSelect"></select></label>
  <label>Date: <input type="date" id="weightDate"></label>
  <label>Weight (g): 
    <input type="number" id="animalWeight" placeholder="Enter weight in grams" 
           oninput="document.getElementById('feedResult').innerHTML = calculateFeedForWeight(parseFloat(this.value))">
  </label>
  <button onclick="addWeight()">Add Weight</button>
  <div class="result" id="feedResult"></div>
  <div id="weightHistory"></div>
  <canvas id="weightChart"></canvas>
</div>

<div id="animalModal" class="modal">
  <div class="modal-content">
    <h3>Edit Animal</h3>
    <label>Name:<input type="text" id="modalAnimalName"></label>
    <label>Species:<input type="text" id="modalAnimalSpecies"></label>
    <div class="modal-buttons">
      <button onclick="closeAnimalModal()">Cancel</button>
      <button onclick="saveAnimalEdit()">Save</button>
    </div>
  </div>
</div>

<div id="weightModal" class="modal">
  <div class="modal-content">
    <h3>Edit Weight</h3>
    <label>Date:<input type="date" id="modalWeightDate"></label>
    <label>Weight (g):<input type="number" id="modalWeightValue"></label>
    <div class="modal-buttons">
      <button onclick="closeWeightModal()">Cancel</button>
      <button onclick="saveWeightEdit()">Save</button>
    </div>
  </div>
</div>

<script>
// --- Feed Schedule ---
const feedSchedule = [
  { weight: 900, feeds: 1 },
  { weight: 500, feeds: 2 },
  { weight: 400, feeds: 3 },
  { weight: 250, feeds: 4 },
  { weight: 150, feeds: 5 },
  { weight: 100, feeds: 6 },
  { weight: 60,  feeds: 8 }
];

function getFeedsPerDay(weight) {
  for (const entry of feedSchedule) {
    if (weight >= entry.weight) return entry.feeds;
  }
  return 8;
}

function calculateFeedForWeight(weight) {
  if (isNaN(weight) || weight <= 0) return '';
  const feeds = getFeedsPerDay(weight);
  const dailyMilk = weight * 0.15;
  const perFeed = dailyMilk / feeds;
  const dailyPowder = dailyMilk * 0.16;
  const perFeedPowder = perFeed * 0.16;
  return `
    <strong>Feed Calculation:</strong><br>
    Weight: ${weight} g<br>
    Feeds per day: ${feeds}<br>
    Daily milk: ${dailyMilk.toFixed(1)} g<br>
    Milk per feed: ${perFeed.toFixed(1)} g<br>
    Daily powder: ${dailyPowder.toFixed(1)} g<br>
    Powder per feed: ${perFeedPowder.toFixed(1)} g
  `;
}

// --- Animal Management ---
let animals = JSON.parse(localStorage.getItem('animals')) || [];
let weightChart;
let editingAnimalId = null;
let editingWeightIndex = null;

function addAnimal() {
  const name = document.getElementById('animalName').value.trim();
  const species = document.getElementById('animalSpecies').value.trim();
  if (!name || !species) return;
  animals.push({ id: Date.now(), name, species, weights: [] });
  localStorage.setItem('animals', JSON.stringify(animals));
  renderAnimals();
  document.getElementById('animalName').value = '';
  document.getElementById('animalSpecies').value = '';
}

function deleteAnimal(id) {
  if (!confirm("Delete this animal and all weights?")) return;
  animals = animals.filter(a => a.id != id);
  localStorage.setItem('animals', JSON.stringify(animals));
  renderAnimals();
}

function editAnimal(id) {
  const a = animals.find(a => a.id == id); if (!a) return;
  editingAnimalId = id;
  document.getElementById('modalAnimalName').value = a.name;
  document.getElementById('modalAnimalSpecies').value = a.species;
  document.getElementById('animalModal').style.display = 'flex';
}

function closeAnimalModal() { editingAnimalId=null; document.getElementById('animalModal').style.display='none'; }

function saveAnimalEdit() {
  if (editingAnimalId === null) return;
  const a = animals.find(a=>a.id==editingAnimalId);
  const name = document.getElementById('modalAnimalName').value.trim();
  const species = document.getElementById('modalAnimalSpecies').value.trim();
  if (name && species) { a.name=name; a.species=species; localStorage.setItem('animals', JSON.stringify(animals)); renderAnimals(); renderWeights(a); }
  closeAnimalModal();
}

function renderAnimals() {
  const list = document.getElementById('animalList');
  const select = document.getElementById('animalSelect');
  list.innerHTML=''; select.innerHTML='';
  animals.forEach(a=>{
    const div=document.createElement('div');
    div.textContent=`${a.name} (${a.species}) `;
    const delBtn=document.createElement('button'); delBtn.textContent='🗑️'; delBtn.style.marginLeft='8px';
    delBtn.addEventListener('click', ()=>deleteAnimal(a.id));
    const editBtn=document.createElement('button'); editBtn.textContent='✏️'; editBtn.style.marginLeft='4px';
    editBtn.addEventListener('click', ()=>editAnimal(a.id));
    div.appendChild(delBtn); div.appendChild(editBtn); list.appendChild(div);
    const opt=document.createElement('option'); opt.value=a.id; opt.textContent=a.name; select.appendChild(opt);
  });
  if (animals.length>0) {
    const selectedId=select.value||animals[0].id; select.value=selectedId;
    renderWeights(animals.find(a=>a.id==selectedId));
  } else { document.getElementById('weightHistory').innerHTML=''; document.getElementById('feedResult').innerHTML=''; if(weightChart) weightChart.destroy(); }
}

// --- Weight Management ---
function addWeight() {
  const id=document.getElementById('animalSelect').value;
  const date=document.getElementById('weightDate').value;
  const weight=parseFloat(document.getElementById('animalWeight').value);
  const a=animals.find(a=>a.id==id);
  if(!a||!date||isNaN(weight)) return;
  a.weights.push({date,weight}); localStorage.setItem('animals',JSON.stringify(animals));
  renderWeights(a);
  document.getElementById('feedResult').innerHTML = calculateFeedForWeight(weight);
  document.getElementById('weightDate').value=''; document.getElementById('animalWeight').value='';
}

function deleteWeight(animalId,index){const a=animals.find(a=>a.id==animalId); if(!a) return; a.weights.splice(index,1); localStorage.setItem('animals',JSON.stringify(animals)); renderWeights(a);}
function editWeight(animalId,index){const a=animals.find(a=>a.id==animalId); if(!a) return; editingAnimalId=animalId; editingWeightIndex=index; const w=a.weights[index]; document.getElementById('modalWeightDate').value=w.date; document.getElementById('modalWeightValue').value=w.weight; document.getElementById('weightModal').style.display='flex';}
function closeWeightModal(){ editingAnimalId=null; editingWeightIndex=null; document.getElementById('weightModal').style.display='none';}
function saveWeightEdit(){ if(editingAnimalId===null||editingWeightIndex===null) return; const a=animals.find(a=>a.id==editingAnimalId); const d=document.getElementById('modalWeightDate').value; const w=parseFloat(document.getElementById('modalWeightValue').value); if(d&&!isNaN(w)){ a.weights[editingWeightIndex]={date:d,weight:w}; localStorage.setItem('animals',JSON.stringify(animals)); renderWeights(a); } closeWeightModal();}

function renderWeights(a){
  const history=document.getElementById('weightHistory'); history.innerHTML='';
  a.weights.sort((w1,w2)=>new Date(w1.date)-new Date(w2.date));
  a.weights.forEach((w,i)=>{
    const div=document.createElement('div'); div.innerHTML=`${w.date}: ${w.weight} g `;
    const delBtn=document.createElement('button'); delBtn.textContent='❌'; delBtn.style.marginLeft='4px'; delBtn.addEventListener('click',()=>deleteWeight(a.id,i));
    const editBtn=document.createElement('button'); editBtn.textContent='✏️'; editBtn.style.marginLeft='4px'; editBtn.addEventListener('click',()=>editWeight(a.id,i));
    div.appendChild(delBtn); div.appendChild(editBtn); history.appendChild(div);
  });
  const labels=a.weights.map(w=>w.date); const data=a.weights.map(w=>w.weight);
  if(weightChart) weightChart.destroy();
  if(labels.length>0){
    const ctx=document.getElementById('weightChart').getContext('2d');
    weightChart=new Chart(ctx,{type:'line',data:{labels, datasets:[{label:a.name+' Weight (g)', data, borderColor:'rgba(43,122,120,1)', backgroundColor:'rgba(43,122,120,0.2)', tension:0.2, pointRadius:4, pointBackgroundColor:'rgba(43,122,120,1)'}]}, options:{responsive:true, plugins:{legend:{display:true}, tooltip:{callbacks:{label:function(context){ const weight=context.raw; const feeds=getFeedsPerDay(weight); const dailyMilk=weight*0.15; const perFeed=dailyMilk/feeds; const dailyPowder=dailyMilk*0.16; const perFeedPowder=perFeed*0.16; return `Weight: ${weight}g, ${feeds} feeds/day, Milk/feed: ${perFeed.toFixed(1)}g, Powder/feed: ${perFeedPowder.toFixed(1)}g`; }}}}, scales:{x:{title:{display:true,text:'Date'}}, y:{title:{display:true,text:'Weight (g)'} , beginAtZero:true}}}});
  }
}

// --- Initialization ---
window.onload=function(){
  renderAnimals();
  document.getElementById('animalSelect').addEventListener('change',function(){
    const a=animals.find(a=>a.id==this.value);
    if(a) renderWeights(a);
  });
};
</script>
</body>
</html>
