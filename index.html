<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BushBuddy</title>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: linear-gradient(135deg, #f5f7fa 0%, #e7f5e4 100%); min-height: 100vh; }
.container { max-width: 1200px; margin: 0 auto; }
.header { text-align: center; margin-bottom: 30px; color: #657a6b; }

/* Navigation */
.main-nav { display: flex; justify-content: center; margin-bottom: 30px; background: white; border-radius: 15px; padding: 10px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); overflow-x: auto; }
.nav-tab { display: flex; flex-direction: column; align-items: center; padding: 12px 16px; margin: 0 4px; border: none; background: transparent; color: #666; cursor: pointer; border-radius: 10px; transition: all 0.3s ease; font-weight: 600; min-width: 80px; font-size: 12px; }
.nav-tab-icon { font-size: 20px; margin-bottom: 4px; }
.nav-tab-text { font-size: 11px; text-align: center; line-height: 1.2; }
.nav-tab:hover { background: rgba(43,122,120,0.1); color: #657a6b; }
.nav-tab.active { background: linear-gradient(135deg, #698167, #a0b2af); color: white; box-shadow: 0 4px 15px rgba(43,122,120,0.3); }

/* Desktop larger tabs */
@media (min-width: 769px) {
  .nav-tab { padding: 16px 20px; min-width: 100px; }
  .nav-tab-icon { font-size: 24px; margin-bottom: 6px; }
  .nav-tab-text { font-size: 12px; }
}

/* Cards */
.card { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); margin-bottom: 25px; }
.card h2 { margin-top: 0; color: #698167; font-size: 1.8em; }

/* Forms */
label { display: block; margin-top: 15px; font-weight: 600; color: #555; }
input, select, textarea { width: 100%; padding: 12px; margin-top: 6px; border-radius: 10px; border: 2px solid #e1e8ed; box-sizing: border-box; font-size: 16px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
input:focus, select:focus, textarea:focus { outline: none; border-color: #698167; box-shadow: 0 0 0 3px rgba(43,122,120,0.1); }
textarea { resize: vertical; min-height: 80px; }

/* Buttons */
button { margin: 8px 4px; padding: 12px 20px; border: none; border-radius: 10px; background: linear-gradient(135deg, #698167, #a0b2af); color: white; cursor: pointer; font-weight: 600; transition: all 0.3s ease; min-height: 44px; font-size: 14px; }
button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(43,122,120,0.3); }
button.small { padding: 8px 12px; font-size: 12px; margin: 2px; min-height: 36px; }
button.danger { background: linear-gradient(135deg, #dc3545, #e74c3c); }

/* Content */
.tab-content { display: none; }
.tab-content.active { display: block; animation: fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

/* Animal grid */
.animal-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
.animal-item { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 6px 25px rgba(0,0,0,0.1); position: relative; }
.animal-item h4 { margin-top: 0; color: #698167; }
.animal-actions { position: absolute; top: 15px; right: 15px; display: flex; gap: 5px; }

/* Results */
.result { margin-top: 15px; padding: 15px; border-radius: 12px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-left: 4px solid #698167; }

/* Mobile */
@media (max-width: 768px) {
  body { padding: 10px; }
  
  /* Mobile logo sizing */
  .header img {
    max-height: 80px;
    max-width: 90vw;
  }
  
  .main-nav { 
    padding: 8px; 
    overflow-x: auto; 
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE/Edge */
    justify-content: flex-start;
  }
  .main-nav::-webkit-scrollbar { display: none; } /* Chrome/Safari */
  .nav-tab { 
    padding: 10px 8px; 
    margin: 0 1px; 
    min-width: 65px; 
    flex-shrink: 0;
  }
  .nav-tab-icon { font-size: 16px; margin-bottom: 2px; }
  .nav-tab-text { font-size: 9px; line-height: 1.1; }
  .card { padding: 20px; }
  .animal-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <img src="BushBuddy.png" alt="BushBuddy Logo" style="max-height: 120px; max-width: 100%; height: auto; margin-bottom: 0;">
  </div>

  <div class="main-nav">
    <button class="nav-tab active" onclick="showTab('animals')">
      <div class="nav-tab-icon">üêæ</div>
      <div class="nav-tab-text">Animal<br>Management</div>
    </button>
    <button class="nav-tab" onclick="showTab('weight')">
      <div class="nav-tab-icon">‚öñÔ∏è</div>
      <div class="nav-tab-text">Weight &<br>Feed</div>
    </button>
    <button class="nav-tab" onclick="showTab('health')">
      <div class="nav-tab-icon">üè•</div>
      <div class="nav-tab-text">Health<br>Tracking</div>
    </button>
    <button class="nav-tab" onclick="showTab('schedule')">
      <div class="nav-tab-icon">üìÖ</div>
      <div class="nav-tab-text">Feeding<br>Schedule</div>
    </button>
    <button class="nav-tab" onclick="showTab('gallery')">
      <div class="nav-tab-icon">üì∏</div>
      <div class="nav-tab-text">Photo<br>Gallery</div>
    </button>
    <button class="nav-tab" onclick="showTab('export')">
      <div class="nav-tab-icon">üìã</div>
      <div class="nav-tab-text">Care<br>Handover</div>
    </button>
  </div>

  <!-- Animals Tab -->
  <div id="animalsTab" class="tab-content active">
    <div class="card">
      <h2>Add New Animal</h2>
      <label>Name: <input type="text" id="animalName" placeholder="Enter animal name"></label>
      <label>Species: 
        <select id="animalSpecies">
          <option value="Common Brushtail Possum">Common Brushtail Possum</option>
          <option value="Ringtail Possum">Ringtail Possum</option>
          <option value="Short-Eared Brushtail Possum">Short-Eared Brushtail Possum</option>
        </select>
      </label>
      <label>Intake Date: <input type="date" id="intakeDate"></label>
      <label>Intake Notes: <textarea id="intakeNotes" placeholder="Circumstances of rescue, initial condition, etc."></textarea></label>
      <button onclick="addAnimal()">Add Animal</button>
    </div>

    <div class="card">
      <h2>Your Animals</h2>
      
      <!-- Search & Filter Controls -->
      <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
        <input type="text" id="animalSearch" placeholder="Search by name, species, or notes..." 
               style="flex: 1; min-width: 200px;">
        
        <select id="speciesFilter" 
                style="min-width: 200px; padding: 10px; border-radius: 10px; border: 2px solid #e1e8ed;">
          <option value="">All Species</option>
          <option value="Common Brushtail Possum">Common Brushtail Possum</option>
          <option value="Ringtail Possum">Ringtail Possum</option>
          <option value="Short-Eared Brushtail Possum">Short-Eared Brushtail Possum</option>
        </select>
      </div>
      
      <!-- Counter -->
      <p id="animalCounter" style="color: #666; font-size: 14px; margin-bottom: 10px;"></p>

      <div id="animalList" class="animal-grid">
        <p style="text-align: center; color: #666; font-style: italic;">No animals added yet. Add your first animal above!</p>
      </div>
    </div>
  </div>

  <!-- Weight Tab -->
  <div id="weightTab" class="tab-content">
    <div class="card">
      <h2>Weight Tracking & Feed Calculator</h2>
      <label>Select Animal: <select id="animalSelect" onchange="onAnimalSelectChange()"></select></label>
      <label>Date: <input type="date" id="weightDate"></label>
      <label>Weight (g): <input type="number" id="animalWeight" placeholder="Enter weight in grams" oninput="showFeedCalc()"></label>
      <button onclick="addWeight()">Add Weight</button>
      <div id="feedResult" class="result"></div>
      <div id="weightHistory" style="margin-top: 20px;"></div>
    </div>
  </div>

  <!-- Health Tab -->
  <div id="healthTab" class="tab-content">
    <div class="card">
      <h2>Health Condition Tracking</h2>
      <label>Select Animal: <select id="healthAnimalSelect" onchange="onHealthAnimalSelectChange()"></select></label>
      <label>Date: <input type="date" id="healthDate"></label>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px; margin: 15px 0;">
        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <label>Body Condition:</label>
          <select id="bodyCondition">
            <option value="poor">Poor</option>
            <option value="fair">Fair</option>
            <option value="good" selected>Good</option>
          </select>
        </div>
        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <label>Alertness:</label>
          <select id="alertness">
            <option value="poor">Poor</option>
            <option value="fair">Fair</option>
            <option value="good" selected>Good</option>
          </select>
        </div>
        <div style="text-align: center; padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <label>Appetite:</label>
          <select id="appetite">
            <option value="poor">Poor</option>
            <option value="fair">Fair</option>
            <option value="good" selected>Good</option>
          </select>
        </div>
      </div>
      <label>Health Notes: <textarea id="healthNotes" placeholder="Observations, concerns, treatments..."></textarea></label>
      <button onclick="addHealthEntry()">Add Health Entry</button>
      <div id="healthHistory" style="margin-top: 20px;"></div>
    </div>
  </div>

  <!-- Feeding Schedule Tab -->
  <div id="scheduleTab" class="tab-content">
    <div class="card">
      <h2>Feeding Schedule</h2>
      <label>Select Animal: <select id="scheduleAnimalSelect" onchange="onScheduleAnimalSelectChange()"></select></label>
      <div id="scheduleDisplay" style="margin-top: 20px;">
        <p style="text-align: center; color: #666; font-style: italic;">Select an animal to view feeding schedule</p>
      </div>
    </div>
  </div>

  <!-- Photo Gallery Tab -->
  <div id="galleryTab" class="tab-content">
    <div class="card">
      <h2>Photo Gallery</h2>
      <label>Select Animal: <select id="galleryAnimalSelect" onchange="onGalleryAnimalSelectChange()"></select></label>
      <div style="margin-top: 20px;">
        <label>Add Photo: <input type="file" id="photoInput" accept="image/*" multiple></label>
        <button onclick="addPhotos()">Add Photos</button>
      </div>
      <div id="photoGallery" style="margin-top: 20px;">
        <p style="text-align: center; color: #666; font-style: italic;">Select an animal to view photos</p>
      </div>
    </div>
  </div>

  <!-- Export Tab -->
  <div id="exportTab" class="tab-content">
    <div class="card">
      <h2>Care Handover</h2>
      <label>Select Animal for Export: <select id="exportAnimalSelect"><option value="">Select an animal...</option></select></label>
      <button onclick="exportAnimalData()">Export Care Data</button>
      
      <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #f8f9fa, #e9ecef); border-radius: 15px;">
        <h4>Backup & Restore</h4>
        <button onclick="exportAllData()">Backup All Data</button>
        <label>Restore Data: <input type="file" id="restoreInput" accept=".json"></label>
        <button onclick="restoreData()">Restore from Backup</button>
      </div>
    </div>
  </div>
</div>

<footer style="margin-top: 50px; padding: 30px 20px; background: rgba(255,255,255,0.9); border-top: 1px solid #e0e0e0; text-align: center; font-size: 12px; color: #666;">
  <div style="max-width: 1200px; margin: 0 auto;">
    <p><strong>Disclaimer:</strong> BushBuddy is a record-keeping tool designed to assist qualified wildlife carers. This application does not provide veterinary or professional wildlife care advice. Always consult with licensed wildlife veterinarians and follow established wildlife care protocols.</p>
    <p style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0;">¬© 2025 BushBuddy. All rights reserved.</p>
  </div>
</footer>

<script>
// Global variables
var animals = [];

// Species data with feeding schedules
var speciesData = {
  "Common Brushtail Possum": [
    { weight: 900, feeds: 1, predictedAge: "7 months", features: "Fully independent from Mum in the wild. No human interaction.", housing: "Large outdoor release aviary (min 3m x 2m x 2m)", feedingNotes: "1 milk feed per day at dusk.", milkFormula: "Maximum 40mL per feed." },
    { weight: 500, feeds: 2, predictedAge: "5.5 - 6 months", features: "Would still cling to mother's back in wild.", housing: "Large outdoor release aviary (min 3m x 2m x 2m)", feedingNotes: "2 milk feeds per day. Offer early morning and late evening.", milkFormula: "MAXIMUM of 40mls in a single feed. 15% of body weight divided equally over 2 feeds." },
    { weight: 400, feeds: 3, predictedAge: "5 months", features: "Dense fur. Dark pellets. Still riding on Mum's back but more confident climbing.", housing: "Large indoor cage (1m x 1m x 1.2m)", feedingNotes: "3 milk feeds per day. Offer early morning, mid afternoon and late evening.", milkFormula: "Milk: 15% of body weight divided equally over 3 feeds" },
    { weight: 250, feeds: 4, predictedAge: "4.5 months", features: "Short dense fur. Soft pellets. More confident out of mum's pouch.", housing: "Carry cage of basket with secure lid and fine mesh", feedingNotes: "4 feeds per day. Milk ‚Äì 6 hourly.", milkFormula: "Milk: 15% of body weight divided equally over 4 feeds" },
    { weight: 150, feeds: 5, predictedAge: "4 months", features: "Fine soft fur, teeth. Darker tube-like faeces.", housing: "Carry cage of basket with secure lid and fine mesh", feedingNotes: "5 feeds per day. Milk approximately 5 hourly.", milkFormula: "Milk: 15% of body weight divided equally over 5 feeds." },
    { weight: 100, feeds: 6, predictedAge: "3.5 months", features: "Cutting fur, eyes open. Thick, custard-like faeces.", housing: "Carry cage of basket with secure lid and fine mesh", feedingNotes: "6 feeds per day. Milk ‚Äì 4 hourly.", milkFormula: "Milk: 15% of body weight divided equally over 6 feeds." }
  ],
  "Ringtail Possum": [
    { weight: 400, feeds: 1, predictedAge: "7 months", features: "Fully independent from Mum in the wild.", housing: "Large outdoor release aviary (min 3m x 2m x 2m)", feedingNotes: "1 milk feed per day at dusk.", milkFormula: "Maximum 30mL per feed." },
    { weight: 300, feeds: 2, predictedAge: "6 months", features: "Fully independent. Very active at night.", housing: "Large outdoor release aviary (min 3m x 2m x 2m)", feedingNotes: "Offer early morning and late evening.", milkFormula: "MAXIMUM of 25mls in a single feed. 15% of body weight divided equally over 2 feeds." },
    { weight: 175, feeds: 3, predictedAge: "5 months", features: "Thick fur. Dark pellets. Still riding on mum's back.", housing: "Large indoor cage (1m x 1m x 1.2m)", feedingNotes: "Offer early morning, mid afternoon and late evening.", milkFormula: "Milk: 15% of body weight divided equally over 3 feeds" },
    { weight: 130, feeds: 4, predictedAge: "4.5 months", features: "Fluffy fur. Dark Pellets. More confident outside of mum's pouch.", housing: "Large indoor cage (1m x 1m x 1.2m)", feedingNotes: "Milk ‚Äì 6 hourly.", milkFormula: "Milk: 15% of body weight divided equally over 4 feeds." },
    { weight: 100, feeds: 5, predictedAge: "4 months", features: "Fine soft fluffy fur. Teeth. Darker tube-like faeces or pellets.", housing: "Large indoor cage (1m x 1m x 1.2m)", feedingNotes: "Milk approximately 5 hourly.", milkFormula: "Milk: 15% of body weight divided equally over 5 feeds." },
    { weight: 80, feeds: 6, predictedAge: "3.5 months", features: "Short fur, eyes open. Dark tube like faeces or pellets.", housing: "Carry cage of basket with secure lid and fine mesh", feedingNotes: "6 feeds per day. Milk ‚Äì 4 hourly.", milkFormula: "Milk: 15% of body weight divided equally over 6 feeds." }
  ],
  "Short-Eared Brushtail Possum": [
    { weight: 1100, feeds: 1, predictedAge: "7 months", features: "Fully independent from Mum in the wild.", housing: "Large outdoor release aviary, (minimum 3m x 2m x 2m)", feedingNotes: "1 milk feed per day at dusk.", milkFormula: "Maximum 40mL per feed." },
    { weight: 650, feeds: 2, predictedAge: "5.6 - 6 months", features: "Would still cling to mother's back in wild.", housing: "Large outdoor release aviary, (minimum 3m x 2m x 2m)", feedingNotes: "2 milk feeds per day. Offer early morning and late evening.", milkFormula: "MAXIMUM of 40mls in a single feed. 15% of body weight divided equally over 2 feeds." },
    { weight: 500, feeds: 3, predictedAge: "5 months", features: "Dense fur. Dark pellets. Still riding on Mum's back.", housing: "Large cage (1m x 1m x 1.2m)", feedingNotes: "3 feeds per day. Offer early morning, mid afternoon and late evening.", milkFormula: "Milk: 15% of body weight divided equally over 3 feeds" },
    { weight: 275, feeds: 4, predictedAge: "4.5 months", features: "Short dense fur. Soft pellets. More confident out of mum's pouch.", housing: "Carry cage of basket with secure lid and fine mesh", feedingNotes: "4 feeds per day. Milk ‚Äì 6 hourly.", milkFormula: "Milk: 15% of body weight divided equally over 4 feeds." },
    { weight: 200, feeds: 5, predictedAge: "4 months", features: "Fine soft fur, teeth. Darker tube-like faeces.", housing: "Carry cage of basket with secure lid and fine mesh", feedingNotes: "5 feeds per day. Milk approximately 5 hourly.", milkFormula: "Milk: 15% of body weight divided equally over 5 feeds." },
    { weight: 150, feeds: 6, predictedAge: "3.5 months", features: "Cutting fur, eyes open. Thick, custard-like faeces.", housing: "Carry cage of basket with secure lid and fine mesh", feedingNotes: "6 feeds per day. Milk ‚Äì 4 hourly.", milkFormula: "Milk: 15% of body weight divided equally over 6 feeds." }
  ]
};

// Utility functions
function formatDate(dateStr) {
  if (!dateStr) return '';
  var date = new Date(dateStr);
  var day = String(date.getDate()).padStart(2, '0');
  var month = String(date.getMonth() + 1).padStart(2, '0');
  var year = date.getFullYear();
  return day + '-' + month + '-' + year;
}

function saveData() {
  try {
    var dataStr = JSON.stringify(animals);
    var dataSize = new Blob([dataStr]).size;
    
    console.log('Attempting to save data. Size:', dataSize, 'bytes');
    console.log('Number of animals:', animals.length);
    
    // Check if we're approaching localStorage limits
    if (dataSize > 5000000) { // 5MB warning
      console.warn('Data size is large:', dataSize, 'bytes. This may cause storage issues.');
    }
    
    localStorage.setItem('bushbuddy_animals', dataStr);
    
    // Verify the save worked
    var savedData = localStorage.getItem('bushbuddy_animals');
    if (savedData && savedData === dataStr) {
      console.log('Data saved and verified successfully');
    } else {
      throw new Error('Data verification failed after save');
    }
    
  } catch (e) {
    console.error('Error saving data:', e);
    console.log('Error name:', e.name);
    console.log('Error message:', e.message);
    
    if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
      alert('Storage quota exceeded. Your data is too large to save locally. Please export your data as backup and consider removing old photos.');
    } else if (e.name === 'SecurityError') {
      alert('Storage blocked by browser security settings. Please check if you\'re in private/incognito mode.');
    } else {
      alert('Error saving data: ' + e.message + '. Please try again.');
    }
  }
}

function loadData() {
  try {
    var saved = localStorage.getItem('bushbuddy_animals');
    if (saved) {
      animals = JSON.parse(saved);
      console.log('Data loaded successfully:', animals.length, 'animals');
    } else {
      animals = [];
      console.log('No saved data found');
    }
  } catch (e) {
    console.error('Error loading data:', e);
    animals = [];
    alert('Error loading saved data. Starting fresh.');
  }
}

function setDefaultDates() {
  var today = new Date().toISOString().split('T')[0];
  document.getElementById('intakeDate').value = today;
  document.getElementById('weightDate').value = today;
  document.getElementById('healthDate').value = today;
}

function getFeedsPerDay(weight, species) {
  var schedule = speciesData[species] || speciesData["Common Brushtail Possum"];
  for (var i = 0; i < schedule.length; i++) {
    if (weight >= schedule[i].weight) return schedule[i].feeds;
  }
  return schedule[schedule.length - 1].feeds;
}

function getAnimalInfo(weight, species) {
  var schedule = speciesData[species] || speciesData["Common Brushtail Possum"];
  for (var i = 0; i < schedule.length; i++) {
    if (weight >= schedule[i].weight) return schedule[i];
  }
  return schedule[schedule.length - 1];
}

// Tab navigation
function showTab(tabName) {
  document.querySelectorAll('.nav-tab').forEach(function(tab) { 
    tab.classList.remove('active'); 
  });
  document.querySelectorAll('.tab-content').forEach(function(content) { 
    content.classList.remove('active'); 
  });
  
  event.target.closest('.nav-tab').classList.add('active');
  document.getElementById(tabName + 'Tab').classList.add('active');
  
  updateSelects();
  
  if (tabName === 'weight') {
    var animalSelect = document.getElementById('animalSelect');
    if (animalSelect.value) {
      onAnimalSelectChange();
    }
  }
}

// Update all select dropdowns
function updateSelects() {
  var selects = ['animalSelect', 'healthAnimalSelect', 'scheduleAnimalSelect', 'galleryAnimalSelect', 'exportAnimalSelect'];
  
  selects.forEach(function(selectId) {
    var select = document.getElementById(selectId);
    if (!select) return;
    var currentValue = select.value;
    
    select.innerHTML = '<option value="">Select an animal...</option>';
    
    animals.forEach(function(animal) {
      var option = document.createElement('option');
      option.value = animal.id;
      option.textContent = animal.name + ' (' + animal.species + ')';
      select.appendChild(option);
    });
    
    if (currentValue && animals.some(function(a) { return a.id == currentValue; })) {
      select.value = currentValue;
    }
  });
}

// Animal management
function addAnimal() {
  var name = document.getElementById('animalName').value.trim();
  var species = document.getElementById('animalSpecies').value;
  var intakeDate = document.getElementById('intakeDate').value;
  var intakeNotes = document.getElementById('intakeNotes').value.trim();
  
  if (!name || !species) {
    alert('Please enter animal name and species.');
    return;
  }
  
  var newAnimal = {
    id: Date.now(),
    name: name,
    species: species,
    intakeDate: intakeDate || new Date().toISOString().split('T')[0],
    intakeNotes: intakeNotes,
    weights: [],
    healthEntries: [],
    photos: []
  };
  
  animals.push(newAnimal);
  saveData();
  
  document.getElementById('animalName').value = '';
  document.getElementById('intakeDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('intakeNotes').value = '';
  
  renderAnimals();
  updateSelects();
  alert(name + ' has been added successfully!');
}

function editAnimal(id) {
  var animal = animals.find(function(a) { return a.id == id; });
  if (!animal) return;
  
  // Populate form with existing data
  document.getElementById('animalName').value = animal.name;
  document.getElementById('animalSpecies').value = animal.species;
  document.getElementById('intakeDate').value = animal.intakeDate;
  document.getElementById('intakeNotes').value = animal.intakeNotes || '';
  
  // Change button to update mode
  var button = document.querySelector('#animalsTab button[onclick="addAnimal()"]');
  button.textContent = 'Update Animal';
  button.onclick = function() { updateAnimal(id); };
  
  // Scroll to form
  document.getElementById('animalsTab').scrollIntoView({ behavior: 'smooth' });
  document.getElementById('animalName').focus();
}

function updateAnimal(id) {
  var animal = animals.find(function(a) { return a.id == id; });
  if (!animal) return;
  
  var name = document.getElementById('animalName').value.trim();
  var species = document.getElementById('animalSpecies').value;
  var intakeDate = document.getElementById('intakeDate').value;
  var intakeNotes = document.getElementById('intakeNotes').value.trim();
  
  if (!name || !species) {
    alert('Please enter animal name and species.');
    return;
  }
  
  // Update animal data
  animal.name = name;
  animal.species = species;
  animal.intakeDate = intakeDate;
  animal.intakeNotes = intakeNotes;
  
  saveData();
  
  // Clear form and reset button
  document.getElementById('animalName').value = '';
  document.getElementById('intakeDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('intakeNotes').value = '';
  
  var button = document.querySelector('#animalsTab button[onclick="updateAnimal(' + id + ')"]');
  button.textContent = 'Add Animal';
  button.onclick = addAnimal;
  
  renderAnimals();
  updateSelects();
  alert(name + ' has been updated successfully!');
}

function deleteAnimal(id) {
  var animal = animals.find(function(a) { return a.id == id; });
  if (!animal) return;
  
  if (!confirm('Delete ' + animal.name + '? This cannot be undone.')) return;
  
  animals = animals.filter(function(a) { return a.id != id; });
  saveData();
  renderAnimals();
  updateSelects();
}

function renderAnimals() {
  var list = document.getElementById('animalList');
  var counter = document.getElementById('animalCounter');

  // Get filter values
  var searchQuery = document.getElementById('animalSearch') ? document.getElementById('animalSearch').value.trim().toLowerCase() : '';
  var speciesFilter = document.getElementById('speciesFilter') ? document.getElementById('speciesFilter').value : '';

  list.innerHTML = '';
  counter.textContent = '';

  if (animals.length === 0) {
    list.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No animals added yet. Add your first animal above!</p>';
    return;
  }

  // Apply filtering
  var filteredAnimals = animals.filter(function(animal) {
    var matchesSearch = !searchQuery ||
      (animal.name && animal.name.toLowerCase().includes(searchQuery)) ||
      (animal.species && animal.species.toLowerCase().includes(searchQuery)) ||
      (animal.intakeNotes && animal.intakeNotes.toLowerCase().includes(searchQuery));
    
    var matchesSpecies = !speciesFilter || animal.species === speciesFilter;
    
    return matchesSearch && matchesSpecies;
  });

  // Counter update
  counter.textContent = 'Showing ' + filteredAnimals.length + ' of ' + animals.length + ' animals';

  if (filteredAnimals.length === 0) {
    list.innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">No matches found. Try adjusting your search or filter.</p>';
    return;
  }

  // Render filtered animals
  filteredAnimals.forEach(function(animal) {
    var div = document.createElement('div');
    div.className = 'animal-item';
    
    var daysSinceIntake = animal.intakeDate ? 
      Math.floor((new Date() - new Date(animal.intakeDate)) / (1000 * 60 * 60 * 24)) : 
      'Unknown';
    
    div.innerHTML = 
      '<div class="animal-actions">' +
      '<button class="small" onclick="editAnimal(' + animal.id + ')" style="background: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6; margin-right: 5px;">‚úèÔ∏è</button>' +
      '<button class="small" onclick="deleteAnimal(' + animal.id + ')" style="background: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6;">üóëÔ∏è</button>' +
      '</div>' +
      '<h4>' + animal.name + '</h4>' +
      '<p><strong>Species:</strong> ' + animal.species + '</p>' +
      '<p><strong>Intake:</strong> ' + formatDate(animal.intakeDate) + ' (' + daysSinceIntake + ' days ago)</p>' +
      '<p><strong>Records:</strong> ' + (animal.weights ? animal.weights.length : 0) + ' weights, ' + (animal.healthEntries ? animal.healthEntries.length : 0) + ' health entries</p>' +
      (animal.intakeNotes ? '<p><strong>Notes:</strong> ' + animal.intakeNotes + '</p>' : '');
    
    list.appendChild(div);
  });
}

// Weight and feed calculations
function onAnimalSelectChange() {
  var animalId = document.getElementById('animalSelect').value;
  if (animalId) {
    var animal = animals.find(function(a) { return a.id == animalId; });
    if (animal) {
      showWeightHistory(animal);
      var weight = parseFloat(document.getElementById('animalWeight').value);
      if (weight > 0) {
        showFeedCalc();
      }
    }
  } else {
    document.getElementById('feedResult').innerHTML = '';
    document.getElementById('weightHistory').innerHTML = '';
  }
}

function showFeedCalc() {
  var weight = parseFloat(document.getElementById('animalWeight').value);
  var animalId = document.getElementById('animalSelect').value;
  var animal = animals.find(function(a) { return a.id == animalId; });
  
  if (!animal || !weight || weight <= 0) {
    document.getElementById('feedResult').innerHTML = '';
    return;
  }
  
  var species = animal.species;
  var feeds = getFeedsPerDay(weight, species);
  var dailyMilk = weight * 0.15;
  var perFeed = dailyMilk / feeds;
  var info = getAnimalInfo(weight, species);
  
  document.getElementById('feedResult').innerHTML = 
    '<strong>Feed Calculation for ' + species + ' - ' + weight + 'g:</strong><br>' +
    'Feeds per day: ' + feeds + '<br>' +
    'Daily milk: ' + dailyMilk.toFixed(1) + ' g<br>' +
    'Milk per feed: ' + perFeed.toFixed(1) + ' g<br><br>' +
    '<strong>Care Information:</strong><br>' +
    '<strong>Predicted Age:</strong> ' + info.predictedAge + '<br>' +
    '<strong>Features/Behaviour:</strong> ' + info.features + '<br>' +
    '<strong>Housing:</strong> ' + info.housing + '<br>' +
    '<strong>Feeding Notes:</strong> ' + info.feedingNotes + '<br>' +
    '<strong>Milk Formula:</strong> ' + info.milkFormula;
}

function addWeight() {
  var animalId = document.getElementById('animalSelect').value;
  var date = document.getElementById('weightDate').value;
  var weight = parseFloat(document.getElementById('animalWeight').value);
  
  var animal = animals.find(function(a) { return a.id == animalId; });
  
  if (!animal) {
    alert('Please select an animal first.');
    return;
  }
  
  if (!date || !weight || weight <= 0) {
    alert('Please enter a valid date and weight.');
    return;
  }
  
  if (!animal.weights) animal.weights = [];
  animal.weights.push({ date: date, weight: weight });
  
  saveData();
  showFeedCalc();
  showWeightHistory(animal);
  
  document.getElementById('weightDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('animalWeight').value = '';
  
  alert('Weight added successfully!');
}

function editWeight(animalId, date, weight) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal) return;
  
  // Set the animal select
  document.getElementById('animalSelect').value = animalId;
  
  // Populate form with existing data
  document.getElementById('weightDate').value = date;
  document.getElementById('animalWeight').value = weight;
  
  // Change button to update mode
  var button = document.querySelector('#weightTab button[onclick="addWeight()"]');
  button.textContent = 'Update Weight';
  button.onclick = function() { updateWeight(animalId, date, weight); };
  
  // Scroll to form
  document.getElementById('weightTab').scrollIntoView({ behavior: 'smooth' });
  document.getElementById('animalWeight').focus();
}

function updateWeight(animalId, originalDate, originalWeight) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal) return;
  
  var date = document.getElementById('weightDate').value;
  var weight = parseFloat(document.getElementById('animalWeight').value);
  
  if (!date || !weight || weight <= 0) {
    alert('Please enter a valid date and weight.');
    return;
  }
  
  // Find and update the weight entry
  var weightEntry = animal.weights.find(function(w) { 
    return w.date === originalDate && w.weight === originalWeight; 
  });
  
  if (weightEntry) {
    weightEntry.date = date;
    weightEntry.weight = weight;
  }
  
  saveData();
  
  // Clear form and reset button
  document.getElementById('weightDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('animalWeight').value = '';
  
  var button = document.querySelector('#weightTab button');
  button.textContent = 'Add Weight';
  button.onclick = addWeight;
  
  showWeightHistory(animal);
  onAnimalSelectChange();
  alert('Weight updated successfully!');
}

function showWeightHistory(animal) {
  var history = document.getElementById('weightHistory');
  history.innerHTML = '<h4>Weight History for ' + animal.name + '</h4>';
  
  if (!animal.weights || animal.weights.length === 0) {
    history.innerHTML += '<p style="color: #666; font-style: italic;">No weight records yet.</p>';
    return;
  }
  
  var sorted = animal.weights.slice().sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
  var mostRecent = sorted[0];
  
  if (mostRecent) {
    var species = animal.species;
    var feeds = getFeedsPerDay(mostRecent.weight, species);
    var dailyMilk = mostRecent.weight * 0.15;
    var perFeed = dailyMilk / feeds;
    var info = getAnimalInfo(mostRecent.weight, species);
    
    var currentWeight = parseFloat(document.getElementById('animalWeight').value);
    if (!currentWeight || currentWeight <= 0) {
      document.getElementById('feedResult').innerHTML = 
        '<strong>Current Feed Calculation for ' + species + ' - ' + mostRecent.weight + 'g:</strong><br>' +
        '<em>Based on most recent weight (' + formatDate(mostRecent.date) + ')</em><br><br>' +
        'Feeds per day: ' + feeds + '<br>' +
        'Daily milk: ' + dailyMilk.toFixed(1) + ' g<br>' +
        'Milk per feed: ' + perFeed.toFixed(1) + ' g<br><br>' +
        '<strong>Care Information:</strong><br>' +
        '<strong>Predicted Age:</strong> ' + info.predictedAge + '<br>' +
        '<strong>Features/Behaviour:</strong> ' + info.features + '<br>' +
        '<strong>Housing:</strong> ' + info.housing + '<br>' +
        '<strong>Feeding Notes:</strong> ' + info.feedingNotes + '<br>' +
        '<strong>Milk Formula:</strong> ' + info.milkFormula;
    }
  }
  
  history.innerHTML += '<div style="margin-top: 15px;"><strong>Weight Records:</strong></div>';
  
  sorted.forEach(function(w, index) {
    var div = document.createElement('div');
    div.style.cssText = 'padding: 10px; margin: 5px 0; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center;';
    
    var weightChange = '';
    if (index < sorted.length - 1) {
      var prevWeight = sorted[index + 1].weight;
      var change = w.weight - prevWeight;
      if (change > 0) {
        weightChange = ' <span style="color: #28a745;">(+' + change.toFixed(0) + 'g)</span>';
      } else if (change < 0) {
        weightChange = ' <span style="color: #dc3545;">(' + change.toFixed(0) + 'g)</span>';
      }
    }
    
    div.innerHTML = 
      '<div>' +
      '<strong>' + formatDate(w.date) + '</strong><br>' +
      w.weight + 'g' + weightChange +
      '</div>' +
      '<div style="display: flex; gap: 5px;">' +
      '<button class="small" onclick="editWeight(' + animal.id + ', \'' + w.date + '\', ' + w.weight + ')" style="background: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6;">‚úèÔ∏è</button>' +
      '<button class="small" onclick="deleteWeight(' + animal.id + ', \'' + w.date + '\', ' + w.weight + ')" style="background: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6;">üóëÔ∏è</button>' +
      '</div>';
    
    history.appendChild(div);
  });
}

function deleteWeight(animalId, date, weight) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal || !animal.weights) return;
  
  if (!confirm('Delete weight record: ' + weight + 'g on ' + formatDate(date) + '?')) return;
  
  animal.weights = animal.weights.filter(function(w) { 
    return !(w.date === date && w.weight === weight); 
  });
  
  saveData();
  showWeightHistory(animal);
  onAnimalSelectChange();
}

// Health tracking
function onHealthAnimalSelectChange() {
  var animalId = document.getElementById('healthAnimalSelect').value;
  if (animalId) {
    var animal = animals.find(function(a) { return a.id == animalId; });
    if (animal) {
      showHealthHistory(animal);
    }
  } else {
    document.getElementById('healthHistory').innerHTML = '';
  }
}

function addHealthEntry() {
  var animalId = document.getElementById('healthAnimalSelect').value;
  var date = document.getElementById('healthDate').value;
  var bodyCondition = document.getElementById('bodyCondition').value;
  var alertness = document.getElementById('alertness').value;
  var appetite = document.getElementById('appetite').value;
  var notes = document.getElementById('healthNotes').value.trim();
  
  var animal = animals.find(function(a) { return a.id == animalId; });
  
  if (!animal) {
    alert('Please select an animal first.');
    return;
  }
  
  if (!date) {
    alert('Please enter a date.');
    return;
  }
  
  if (!animal.healthEntries) animal.healthEntries = [];
  
  animal.healthEntries.push({
    date: date,
    bodyCondition: bodyCondition,
    alertness: alertness,
    appetite: appetite,
    notes: notes
  });
  
  saveData();
  showHealthHistory(animal);
  
  document.getElementById('healthDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('bodyCondition').selectedIndex = 2;
  document.getElementById('alertness').selectedIndex = 2;
  document.getElementById('appetite').selectedIndex = 2;
  document.getElementById('healthNotes').value = '';
  
  alert('Health entry added successfully!');
}

function editHealthEntry(animalId, date) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal || !animal.healthEntries) return;
  
  var entry = animal.healthEntries.find(function(e) { return e.date === date; });
  if (!entry) return;
  
  // Set the animal select
  document.getElementById('healthAnimalSelect').value = animalId;
  
  // Populate form with existing data
  document.getElementById('healthDate').value = entry.date;
  document.getElementById('bodyCondition').value = entry.bodyCondition;
  document.getElementById('alertness').value = entry.alertness;
  document.getElementById('appetite').value = entry.appetite;
  document.getElementById('healthNotes').value = entry.notes || '';
  
  // Change button to update mode
  var button = document.querySelector('#healthTab button[onclick="addHealthEntry()"]');
  button.textContent = 'Update Health Entry';
  button.onclick = function() { updateHealthEntry(animalId, date); };
  
  // Scroll to form
  document.getElementById('healthTab').scrollIntoView({ behavior: 'smooth' });
  document.getElementById('healthDate').focus();
}

function updateHealthEntry(animalId, originalDate) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal) return;
  
  var date = document.getElementById('healthDate').value;
  var bodyCondition = document.getElementById('bodyCondition').value;
  var alertness = document.getElementById('alertness').value;
  var appetite = document.getElementById('appetite').value;
  var notes = document.getElementById('healthNotes').value.trim();
  
  if (!date) {
    alert('Please enter a date.');
    return;
  }
  
  // Find and update the health entry
  var healthEntry = animal.healthEntries.find(function(e) { 
    return e.date === originalDate; 
  });
  
  if (healthEntry) {
    healthEntry.date = date;
    healthEntry.bodyCondition = bodyCondition;
    healthEntry.alertness = alertness;
    healthEntry.appetite = appetite;
    healthEntry.notes = notes;
  }
  
  saveData();
  
  // Clear form and reset button
  document.getElementById('healthDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('bodyCondition').selectedIndex = 2;
  document.getElementById('alertness').selectedIndex = 2;
  document.getElementById('appetite').selectedIndex = 2;
  document.getElementById('healthNotes').value = '';
  
  var button = document.querySelector('#healthTab button');
  button.textContent = 'Add Health Entry';
  button.onclick = addHealthEntry;
  
  showHealthHistory(animal);
  alert('Health entry updated successfully!');
}

function showHealthHistory(animal) {
  var history = document.getElementById('healthHistory');
  history.innerHTML = '<h4>Health History for ' + animal.name + '</h4>';
  
  if (!animal.healthEntries || animal.healthEntries.length === 0) {
    history.innerHTML += '<p style="color: #666; font-style: italic;">No health records yet.</p>';
    return;
  }
  
  var sorted = animal.healthEntries.slice().sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
  
  sorted.forEach(function(entry) {
    var div = document.createElement('div');
    div.style.cssText = 'padding: 15px; margin: 10px 0; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);';
    
    var conditionColor = entry.bodyCondition === 'good' ? '#28a745' : entry.bodyCondition === 'fair' ? '#ffc107' : '#dc3545';
    var alertnessColor = entry.alertness === 'good' ? '#28a745' : entry.alertness === 'fair' ? '#ffc107' : '#dc3545';
    var appetiteColor = entry.appetite === 'good' ? '#28a745' : entry.appetite === 'fair' ? '#ffc107' : '#dc3545';
    
    div.innerHTML = 
      '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">' +
      '<strong>' + formatDate(entry.date) + '</strong>' +
      '<div style="display: flex; gap: 5px;">' +
      '<button class="small" onclick="editHealthEntry(' + animal.id + ', \'' + entry.date + '\')" style="background: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6;">‚úèÔ∏è</button>' +
      '<button class="small" onclick="deleteHealthEntry(' + animal.id + ', \'' + entry.date + '\')" style="background: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6;">üóëÔ∏è</button>' +
      '</div>' +
      '</div>' +
      '<div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px;">' +
      '<div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 5px;">' +
      '<div style="font-size: 12px; color: #666;">Body Condition</div>' +
      '<div style="color: ' + conditionColor + '; font-weight: bold; text-transform: capitalize;">' + entry.bodyCondition + '</div>' +
      '</div>' +
      '<div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 5px;">' +
      '<div style="font-size: 12px; color: #666;">Alertness</div>' +
      '<div style="color: ' + alertnessColor + '; font-weight: bold; text-transform: capitalize;">' + entry.alertness + '</div>' +
      '</div>' +
      '<div style="text-align: center; padding: 8px; background: #f8f9fa; border-radius: 5px;">' +
      '<div style="font-size: 12px; color: #666;">Appetite</div>' +
      '<div style="color: ' + appetiteColor + '; font-weight: bold; text-transform: capitalize;">' + entry.appetite + '</div>' +
      '</div>' +
      '</div>' +
      (entry.notes ? '<div style="margin-top: 10px; padding: 8px; background: #f8f9fa; border-radius: 5px;"><strong>Notes:</strong> ' + entry.notes + '</div>' : '');
    
    history.appendChild(div);
  });
}

function deleteHealthEntry(animalId, date) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal || !animal.healthEntries) return;
  
  if (!confirm('Delete health entry from ' + formatDate(date) + '?')) return;
  
  animal.healthEntries = animal.healthEntries.filter(function(entry) { 
    return entry.date !== date; 
  });
  
  saveData();
  showHealthHistory(animal);
}

// Feeding Schedule functions
function onScheduleAnimalSelectChange() {
  var animalId = document.getElementById('scheduleAnimalSelect').value;
  if (animalId) {
    var animal = animals.find(function(a) { return a.id == animalId; });
    if (animal) {
      showFeedingSchedule(animal);
    }
  } else {
    document.getElementById('scheduleDisplay').innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">Select an animal to view feeding schedule</p>';
  }
}

function showFeedingSchedule(animal) {
  var display = document.getElementById('scheduleDisplay');
  
  if (!animal.weights || animal.weights.length === 0) {
    display.innerHTML = '<p style="color: #666; font-style: italic;">No weight records available. Add weights to generate feeding schedule.</p>';
    return;
  }
  
  var sorted = animal.weights.slice().sort(function(a, b) { return new Date(b.date) - new Date(a.date); });
  var mostRecent = sorted[0];
  var species = animal.species;
  var feeds = getFeedsPerDay(mostRecent.weight, species);
  var dailyMilk = mostRecent.weight * 0.15;
  var perFeed = dailyMilk / feeds;
  
  display.innerHTML = '<h4>Daily Feeding Schedule for ' + animal.name + '</h4>';
  display.innerHTML += '<p><strong>Based on current weight:</strong> ' + mostRecent.weight + 'g (' + formatDate(mostRecent.date) + ')</p>';
  display.innerHTML += '<p><strong>Total feeds per day:</strong> ' + feeds + '</p>';
  display.innerHTML += '<p><strong>Milk per feed:</strong> ' + perFeed.toFixed(1) + 'g</p><br>';
  
  var scheduleDiv = document.createElement('div');
  scheduleDiv.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;';
  
  for (var i = 0; i < feeds; i++) {
    var hour = Math.floor((24 / feeds) * i);
    var minute = Math.floor(((24 / feeds) * i - hour) * 60);
    var timeStr = String(hour).padStart(2, '0') + ':' + String(minute).padStart(2, '0');
    
    var feedDiv = document.createElement('div');
    feedDiv.style.cssText = 'padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;';
    feedDiv.innerHTML = 
      '<div style="font-size: 18px; font-weight: bold; color: #698167;">Feed ' + (i + 1) + '</div>' +
      '<div style="font-size: 16px; margin: 8px 0;">' + timeStr + '</div>' +
      '<div style="font-size: 14px; color: #666;">' + perFeed.toFixed(1) + 'g milk</div>';
    
    scheduleDiv.appendChild(feedDiv);
  }
  
  display.appendChild(scheduleDiv);
}

// Photo Gallery functions
function onGalleryAnimalSelectChange() {
  var animalId = document.getElementById('galleryAnimalSelect').value;
  if (animalId) {
    var animal = animals.find(function(a) { return a.id == animalId; });
    if (animal) {
      showPhotoGallery(animal);
    }
  } else {
    document.getElementById('photoGallery').innerHTML = '<p style="text-align: center; color: #666; font-style: italic;">Select an animal to view photos</p>';
  }
}

function addPhotos() {
  var animalId = document.getElementById('galleryAnimalSelect').value;
  var fileInput = document.getElementById('photoInput');
  var files = fileInput.files;
  
  var animal = animals.find(function(a) { return a.id == animalId; });
  
  if (!animal) {
    alert('Please select an animal first.');
    return;
  }
  
  if (files.length === 0) {
    alert('Please select photos to add.');
    return;
  }
  
  if (!animal.photos) animal.photos = [];
  
  var addedCount = 0;
  var totalFiles = files.length;
  
  for (var i = 0; i < files.length; i++) {
    var file = files[i];
    processAndAddPhoto(file, animal, function() {
      addedCount++;
      if (addedCount === totalFiles) {
        saveData();
        showPhotoGallery(animal);
        fileInput.value = '';
        alert(addedCount + ' photo(s) added successfully!');
      }
    });
  }
}

// Compress and process photo before adding
function processAndAddPhoto(file, animal, callback) {
  var actualDate = getPhotoDate(file) || new Date().toISOString().split('T')[0];
  
  // Create image element to compress photo
  var img = new Image();
  img.onload = function() {
    var canvas = document.createElement('canvas');
    var ctx = canvas.getContext('2d');
    
    // Calculate new dimensions - max 1200px width/height to reduce file size
    var maxSize = 1200;
    var width = img.width;
    var height = img.height;
    
    if (width > height) {
      if (width > maxSize) {
        height = (height * maxSize) / width;
        width = maxSize;
      }
    } else {
      if (height > maxSize) {
        width = (width * maxSize) / height;
        height = maxSize;
      }
    }
    
    canvas.width = width;
    canvas.height = height;
    
    // Draw and compress image
    ctx.drawImage(img, 0, 0, width, height);
    
    // Convert to JPEG with 0.8 quality for significant size reduction
    var compressedData = canvas.toDataURL('image/jpeg', 0.8);
    
    console.log('Original size:', file.size, 'bytes');
    console.log('Compressed size estimate:', Math.round(compressedData.length * 0.75), 'bytes');
    
    animal.photos.push({
      data: compressedData,
      name: file.name,
      date: actualDate
    });
    
    callback();
  };
  
  // Load the original file
  var reader = new FileReader();
  reader.onload = function(e) {
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// Extract date from photo metadata
function getPhotoDate(file) {
  try {
    // Try to get date from file's lastModified property first
    if (file.lastModified) {
      var fileDate = new Date(file.lastModified);
      return fileDate.toISOString().split('T')[0];
    }
    
    // For more sophisticated EXIF reading, we'd need a library like exif-js
    // For now, we'll use the file's last modified date as a reasonable approximation
    return null;
  } catch (error) {
    console.log('Could not extract photo date:', error);
    return null;
  }
}

function showPhotoGallery(animal) {
  var gallery = document.getElementById('photoGallery');
  gallery.innerHTML = '<h4>Photos for ' + animal.name + '</h4>';
  
  if (!animal.photos || animal.photos.length === 0) {
    gallery.innerHTML += '<p style="color: #666; font-style: italic;">No photos yet. Add some photos above!</p>';
    return;
  }
  
  var gridDiv = document.createElement('div');
  gridDiv.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 300px)); gap: 15px; margin-top: 15px; justify-content: center;';
  
  animal.photos.forEach(function(photo, index) {
    var photoDiv = document.createElement('div');
    photoDiv.style.cssText = 'position: relative; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden;';
    
    photoDiv.innerHTML = 
      '<img src="' + photo.data + '" onclick="openLightbox(' + animal.id + ',' + index + ')" style="width: 100%; height: 200px; object-fit: cover; cursor: pointer;" title="Click to enlarge">' +
      '<div style="padding: 10px;">' +
      '<div style="font-size: 12px; color: #666;">' + formatDate(photo.date) + '</div>' +
      '<div style="font-size: 10px; color: #999; margin-top: 5px;">' + photo.name + '</div>' +
      '</div>' +
      '<button class="small" onclick="deletePhoto(' + animal.id + ', ' + index + ')" style="position: absolute; top: 5px; right: 5px; background: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6;">üóëÔ∏è</button>';
    
    gridDiv.appendChild(photoDiv);
  });
  
  gallery.appendChild(gridDiv);
}

function deletePhoto(animalId, photoIndex) {
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal || !animal.photos) return;
  
  if (!confirm('Delete this photo?')) return;
  
  animal.photos.splice(photoIndex, 1);
  saveData();
  showPhotoGallery(animal);
}

// Create lightbox HTML dynamically if it doesn't exist
function createLightbox() {
  var lightboxHTML = 
    '<div id="lightbox" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9);">' +
    '<div style="position: relative; margin: auto; padding: 20px; width: 90%; height: 90%; display: flex; align-items: center; justify-content: center; flex-direction: column;">' +
    '<span onclick="closeLightbox()" style="position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; font-weight: bold; cursor: pointer; z-index: 10001;">&times;</span>' +
    '<span onclick="navigateLightbox(-1)" style="position: absolute; top: 50%; left: 30px; transform: translateY(-50%); color: white; font-size: 30px; font-weight: bold; cursor: pointer; background: rgba(255, 255, 255, 0.2); padding: 15px 20px; border-radius: 50%;">&#10094;</span>' +
    '<img id="lightbox-image" src="" alt="" style="max-width: 100%; max-height: 80%; object-fit: contain; border-radius: 10px;">' +
    '<span onclick="navigateLightbox(1)" style="position: absolute; top: 50%; right: 30px; transform: translateY(-50%); color: white; font-size: 30px; font-weight: bold; cursor: pointer; background: rgba(255, 255, 255, 0.2); padding: 15px 20px; border-radius: 50%;">&#10095;</span>' +
    '<div style="background: rgba(255, 255, 255, 0.95); padding: 15px 20px; border-radius: 10px; margin-top: 20px; text-align: center; color: #333;">' +
    '<div id="lightbox-animal-name" style="font-weight: bold; font-size: 18px; margin-bottom: 5px;"></div>' +
    '<div id="lightbox-photo-date" style="color: #666; font-size: 14px; margin-bottom: 5px;"></div>' +
    '<div id="lightbox-photo-name" style="color: #999; font-size: 12px;"></div>' +
    '<div id="lightbox-counter" style="color: #666; font-size: 14px; margin-top: 10px;"></div>' +
    '</div>' +
    '</div>' +
    '</div>';
  
  document.body.insertAdjacentHTML('beforeend', lightboxHTML);
  console.log('Lightbox created dynamically with inline styles');
}

// Simple lightbox functions
function openLightbox(animalId, photoIndex) {
  console.log('openLightbox called with:', animalId, photoIndex);
  
  var animal = animals.find(function(a) { return a.id == animalId; });
  if (!animal) {
    console.log('Animal not found:', animalId);
    return;
  }
  
  if (!animal.photos || animal.photos.length === 0) {
    console.log('No photos found for animal');
    return;
  }
  
  console.log('Found animal with', animal.photos.length, 'photos');
  
  currentLightboxAnimal = animal;
  currentPhotoIndex = photoIndex;
  
  var lightbox = document.getElementById('lightbox');
  console.log('Lightbox element found:', !!lightbox);
  
  if (!lightbox) {
    console.log('Lightbox not found, creating it now');
    createLightbox();
    lightbox = document.getElementById('lightbox');
    console.log('Lightbox created, found now:', !!lightbox);
  }
  
  if (lightbox) {
    updateLightboxContent();
    lightbox.style.display = 'block';
    document.body.style.overflow = 'hidden';
    console.log('Lightbox should now be visible');
  } else {
    console.log('Still unable to create lightbox element');
  }
}

function closeLightbox() {
  var lightbox = document.getElementById('lightbox');
  if (lightbox) {
    lightbox.style.display = 'none';
    document.body.style.overflow = 'auto';
  }
}

function navigateLightbox(direction) {
  if (!currentLightboxAnimal || !currentLightboxAnimal.photos) return;
  
  currentPhotoIndex += direction;
  if (currentPhotoIndex >= currentLightboxAnimal.photos.length) {
    currentPhotoIndex = 0;
  } else if (currentPhotoIndex < 0) {
    currentPhotoIndex = currentLightboxAnimal.photos.length - 1;
  }
  
  updateLightboxContent();
}

function updateLightboxContent() {
  if (!currentLightboxAnimal || !currentLightboxAnimal.photos) return;
  
  var photo = currentLightboxAnimal.photos[currentPhotoIndex];
  var lightboxImage = document.getElementById('lightbox-image');
  var animalName = document.getElementById('lightbox-animal-name');
  var photoDate = document.getElementById('lightbox-photo-date');
  var photoName = document.getElementById('lightbox-photo-name');
  var counter = document.getElementById('lightbox-counter');
  
  if (lightboxImage) lightboxImage.src = photo.data;
  if (animalName) animalName.textContent = currentLightboxAnimal.name;
  if (photoDate) photoDate.textContent = 'Taken: ' + formatDate(photo.date);
  if (photoName) photoName.textContent = photo.name;
  if (counter) counter.textContent = 'Photo ' + (currentPhotoIndex + 1) + ' of ' + currentLightboxAnimal.photos.length;
}

// Export functions
function exportAnimalData() {
  var animalId = document.getElementById('exportAnimalSelect').value;
  var animal = animals.find(function(a) { return a.id == animalId; });
  
  if (!animal) {
    alert('Please select an animal to export.');
    return;
  }
  
  var exportData = {
    animal: animal,
    exportDate: new Date().toISOString(),
    appVersion: 'BushBuddy v1.0'
  };
  
  var dataStr = JSON.stringify(exportData, null, 2);
  var dataBlob = new Blob([dataStr], {type: 'application/json'});
  
  var link = document.createElement('a');
  link.href = URL.createObjectURL(dataBlob);
  link.download = animal.name.replace(/[^a-z0-9]/gi, '_') + '_care_data.json';
  link.click();
}

function exportAllData() {
  if (animals.length === 0) {
    alert('No data to export.');
    return;
  }
  
  var exportData = {
    animals: animals,
    exportDate: new Date().toISOString(),
    appVersion: 'BushBuddy v1.0'
  };
  
  var dataStr = JSON.stringify(exportData, null, 2);
  var dataBlob = new Blob([dataStr], {type: 'application/json'});
  
  var link = document.createElement('a');
  link.href = URL.createObjectURL(dataBlob);
  link.download = 'bushbuddy_backup_' + new Date().toISOString().split('T')[0] + '.json';
  link.click();
}

function restoreData() {
  var fileInput = document.getElementById('restoreInput');
  var file = fileInput.files[0];
  
  if (!file) {
    alert('Please select a backup file to restore.');
    return;
  }
  
  if (!confirm('Restore data from backup? This will replace all current data.')) {
    return;
  }
  
  var reader = new FileReader();
  reader.onload = function(e) {
    try {
      var importData = JSON.parse(e.target.result);
      
      if (importData.animals) {
        animals = importData.animals;
      } else if (importData.animal) {
        var existingIndex = animals.findIndex(function(a) { return a.id === importData.animal.id; });
        if (existingIndex >= 0) {
          animals[existingIndex] = importData.animal;
        } else {
          animals.push(importData.animal);
        }
      } else {
        throw new Error('Invalid backup file format');
      }
      
      saveData();
      renderAnimals();
      updateSelects();
      alert('Data restored successfully!');
      
    } catch (error) {
      console.error('Error importing data:', error);
      alert('Error reading backup file. Please check the file format.');
    }
  };
  
  reader.readAsText(file);
  fileInput.value = '';
}

// Initialize app when DOM is ready
function initApp() {
  loadData();
  setDefaultDates();
  updateSelects();
  renderAnimals();
  
  // Add event listeners for search and filter after functions are loaded
  var searchInput = document.getElementById('animalSearch');
  var speciesFilter = document.getElementById('speciesFilter');
  
  if (searchInput) {
    searchInput.addEventListener('input', renderAnimals);
  }
  
  if (speciesFilter) {
    speciesFilter.addEventListener('change', renderAnimals);
  }
  
  // Add keyboard support for lightbox
  document.addEventListener('keydown', function(e) {
    var lightbox = document.getElementById('lightbox');
    if (lightbox && lightbox.style.display === 'block') {
      if (e.key === 'Escape') {
        closeLightbox();
      } else if (e.key === 'ArrowLeft') {
        navigateLightbox(-1);
      } else if (e.key === 'ArrowRight') {
        navigateLightbox(1);
      }
    }
  });
  
  // Add click-outside-to-close for lightbox
  var lightboxElement = document.getElementById('lightbox');
  if (lightboxElement) {
    lightboxElement.addEventListener('click', function(e) {
      if (e.target === this) {
        closeLightbox();
      }
    });
  }
}

console.log('About to set up DOM ready detection');

if (document.readyState === 'loading') {
  console.log('Document still loading, adding event listener');
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded event fired, calling initApp');
    initApp();
  });
} else {
  console.log('Document already ready, calling initApp immediately');
  initApp();
}

console.log('Script execution completed');
</script>

</body>
</html>
